<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Battery Swap System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f4f4f4; --card:#fff; --muted:#6b7280; --ink:#111827; --primary:#2563eb; --primary-ink:#fff; --danger:#dc2626; --success:#16a34a; }
    *{box-sizing:border-box}
    body { font-family: Arial, sans-serif; margin: 20px; background-color: var(--bg); color: var(--ink); }
    h1 { color: #2c3e50; text-align: center; margin: 10px 0 20px; }
    h2 { color: #34495e; margin: 0 0 10px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); }
    .col-12{grid-column: span 12}
    .col-6{grid-column: span 12}
    @media(min-width:980px){.col-6{grid-column: span 6}}
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    input, button, select { margin: 6px 0; padding: 10px 12px; width: 100%; border-radius: 8px; border: 1px solid #d1d5db; background:#fff; }
    button { background: var(--primary); color: var(--primary-ink); border: none; cursor: pointer; font-weight:600 }
    button:hover { filter: brightness(0.95); }
    button.ghost{background:transparent;color:var(--ink);border:1px solid #d1d5db}
    button.small{padding:6px 10px;font-size:13px;border-radius:999px;width:auto}
    button.approve{background: var(--success)}
    button.cancel{background: var(--danger)}
    pre { background: #f8f9fa; padding: 10px; border-radius: 8px; white-space: pre-wrap; overflow-x: auto; }
    .package-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .package-card { border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
    .package-card h3 { color: #2c3e50; margin-top: 0; }
    .price { color: #e74c3c; font-weight: bold; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align: top; }
    .table th { background:#f1f5f9; }
    .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; background:#eef2ff; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .hint { color: var(--muted); font-size: 12px; }
    .role-tabs{display:flex;gap:8px;justify-content:center;margin:12px 0}
    .role-tabs .pill{padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
    .hide{display:none !important}
    .stack{display:flex;flex-direction:column;gap:6px}
    img.preview { max-width:100%; border:1px solid #e5e7eb; border-radius:8px; display:none }
  </style>
</head>
<body>

<h1>‚ö° Battery Swap System</h1>
<div class="role-tabs">
  <span class="pill" id="pillRole">Vai tr√≤: <strong id="pillRoleText">Guest</strong></span>
  <button class="pill" id="btnSwitchToDriver" title="Ch·ªâ ƒë·ªÉ test UI nhanh">Driver view</button>
  <button class="pill" id="btnSwitchToManager" title="Ch·ªâ ƒë·ªÉ test UI nhanh">Manager view</button>
  <button class="pill" id="btnSwitchToAdmin" title="Ch·ªâ ƒë·ªÉ test UI nhanh">Admin view</button>
</div>

<!-- üîë Auth -->
<div class="grid">
  <div class="col-6 card">
    <h2>üîë ƒêƒÉng nh·∫≠p</h2>
    <input type="text" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" />
    <div class="row">
      <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
      <button class="ghost" id="btnLogout">ƒêƒÉng xu·∫•t</button>
    </div>
    <pre id="loginResult"></pre>
  </div>

  <!-- ‚ÑπÔ∏è User info -->
  <div class="col-6 card">
    <h2>üë§ Phi√™n ƒëƒÉng nh·∫≠p</h2>
    <pre id="whoami">Ch∆∞a ƒëƒÉng nh·∫≠p.</pre>
  </div>
</div>

<!-- ===================== DRIVER / GUEST AREA ===================== -->
<div id="areaDriverGuest">
  <!-- üìé Li√™n k·∫øt xe (Driver) -->
  <div class="card" id="linkVehicleCard">
    <h2>üìé Li√™n k·∫øt xe (Driver)</h2>
    <div class="row" style="margin-bottom:6px">
      <span class="hint">
        Ch·ªâ Driver s·ª≠ d·ª•ng. BE y√™u c·∫ßu <code class="code">multipart/form-data</code> v·ªõi key <code class="code">carDoc</code>.
        Model h·ªó tr·ª£: Gogoro SuperSport, 2 Delight, Viva Mix, CrossOver S, S2 ABS.
      </span>
    </div>

    <div class="grid">
      <div class="col-6">
        <label>·∫¢nh c√† v·∫πt xe (JPEG/PNG, ‚â§ 5MB)</label>
        <input id="carDocInput" type="file" accept="image/*" />
        <div class="hint">Form key: <code class="code">carDoc</code></div>
      </div>
      <div class="col-6">
        <label>Xem tr∆∞·ªõc</label>
        <img id="carDocPreview" class="preview" alt="Preview" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnLinkVehicle">T·∫£i l√™n & Li√™n k·∫øt xe</button>
      <button class="ghost" id="btnClearVehicle">Xo√° ·∫£nh</button>
    </div>

    <pre id="linkVehicleResult" class="code" style="margin-top:8px"></pre>
  </div>

  <!-- ‚ö° Packages -->
  <div class="card">
    <h2>‚ö° C√°c g√≥i pin</h2>
    <div id="packageContainer" class="package-list">ƒêang t·∫£i danh s√°ch...</div>
  </div>

  <!-- üìÖ Booking -->
  <div class="card">
    <h2>üìÖ ƒê·∫∑t tr∆∞·ªõc pin</h2>
    <label>Ch·ªçn lo·∫°i pin:</label>
    <select id="batteryType">
      <option value="Lithium-ion">Lithium-ion</option>
      <option value="LFP">LFP</option>
    </select>

    <label>Ch·ªçn tr·∫°m s·∫°c:</label>
    <select id="bookingStation"></select>

    <label>Ch·ªçn th·ªùi gian l·∫•y pin:</label>
    <input type="datetime-local" id="bookingTime" />

    <button id="btnBooking">ƒê·∫∑t tr∆∞·ªõc</button>
    <pre id="bookingResult"></pre>
  </div>

  <!-- üìú Booking list -->
  <div class="card">
    <h2>üìú Danh s√°ch ƒë·∫∑t ch·ªó</h2>
    <div class="row" style="margin-bottom:8px">
      <button id="btnReloadBookings">T·∫£i l·∫°i</button>
      <span id="bookingHint" class="code">‚Äª Driver ch·ªâ th·∫•y ƒë∆°n c·ªßa m√¨nh; Staff/Admin th·∫•y t·∫•t c·∫£</span>
    </div>
    <div id="bookingsContainer"><em>Ch∆∞a t·∫£i d·ªØ li·ªáu...</em></div>
  </div>

  <!-- üîÑ Check-in / Swap -->
  <div class="card">
    <h2>üîÑ Check-in / ƒê·ªïi pin</h2>
    <label>Nh·∫≠p m√£ Booking ID:</label>
    <input type="number" id="checkinBookingId" placeholder="VD: 1234" />
    <button id="btnCheckin">Check-in & Swap pin</button>
    <pre id="checkinResult"></pre>
  </div>
</div>

<!-- ===================== MANAGER AREA ===================== -->
<div id="areaManager" class="hide">
  <div class="card">
    <h2>üóÇÔ∏è Y√™u c·∫ßu ƒëi·ªÅu ph·ªëi pin (Manager)</h2>
    <div class="hint" style="margin:-4px 0 8px">
      ‚Ä¢ T·∫°o request m·ªõi cho tr·∫°m c·ªßa b·∫°n. Sau khi Admin <strong>Approve</strong>, tr·∫°ng th√°i s·∫Ω l√† <span class="badge">Preparing</span>. Khi h√†ng ƒë√£ giao t·ªõi tr·∫°m, b·∫°n b·∫•m <strong>Confirm ƒë√£ nh·∫≠n</strong> ƒë·ªÉ ho√†n t·∫•t (status ‚Üí <span class="badge">Complete</span>).
    </div>
    <div class="grid">
      <div class="col-6">
        <label>T√™n tr·∫°m (stationName)</label>
        <input id="mgrStationName" placeholder="V√≠ d·ª•: Station Th·ªß ƒê·ª©c" />
      </div>
      <div class="col-6">
        <label>Lo·∫°i pin (batteryName)</label>
        <input id="mgrBatteryName" placeholder="V√≠ d·ª•: LFP" />
      </div>
      <div class="col-6">
        <label>S·ªë l∆∞·ª£ng Good</label>
        <input id="mgrQtyGood" type="number" min="0" value="0" />
      </div>
      <div class="col-6">
        <label>S·ªë l∆∞·ª£ng Average</label>
        <input id="mgrQtyAvg" type="number" min="0" value="0" />
      </div>
      <div class="col-6">
        <label>S·ªë l∆∞·ª£ng Bad</label>
        <input id="mgrQtyBad" type="number" min="0" value="0" />
      </div>
    </div>
    <div class="row">
      <button id="btnMgrSend">G·ª≠i request</button>
      <button class="ghost" id="btnMgrReload">T·∫£i request c·ªßa t√¥i</button>
    </div>
    <pre id="mgrResult"></pre>
  </div>

  <div class="card">
    <h2>üì• Request c·ªßa tr·∫°m t√¥i</h2>
    <div class="hint" style="margin:-4px 0 8px">
      ‚Ä¢ Khi tr·∫°ng th√°i l√† <span class="badge">Preparing</span>, h√£y b·∫•m <strong>Confirm ƒë√£ nh·∫≠n</strong> ƒë·ªÉ ch·ªët ƒëi·ªÅu ph·ªëi & c·∫≠p nh·∫≠t kho.
    </div>
    <div id="mgrPending"><em>Ch∆∞a t·∫£i d·ªØ li·ªáu...</em></div>
  </div>
</div>

<!-- ===================== ADMIN AREA ===================== -->
<div id="areaAdmin" class="hide">
  <div class="card">
    <h2>üõ°Ô∏è Duy·ªát y√™u c·∫ßu ƒëi·ªÅu ph·ªëi (Admin)</h2>
    <div class="row" style="margin-bottom:8px">
      <button id="btnAdminReload">T·∫£i request pending</button>
      <span class="hint">Ch·ªçn tr·∫°m ph·∫£n h·ªìi (stationRespondName) r·ªìi Approve (status ‚Üí <span class="badge">Preparing</span>), ho·∫∑c Cancel ƒë·ªÉ hu·ª∑ y√™u c·∫ßu.</span>
    </div>
    <div id="adminPending"><em>Ch∆∞a t·∫£i d·ªØ li·ªáu...</em></div>
  </div>
</div>

<!-- üìä T·ªïng h·ª£p pin theo tr·∫°m (Admin) -->
<div class="card">
  <h2>üìä Th·ªëng k√™ s·ªë l∆∞·ª£ng pin theo tr·∫°m</h2>
  <div class="row" style="margin-bottom:8px">
    <button id="btnAdminSummaryReload">T·∫£i l·∫°i th·ªëng k√™</button>
    <span class="hint">T√°ch theo lo·∫°i pin (Li-ion/LFP) v√† nh√≥m SoH (Good/Average/Weak/Below75).</span>
  </div>
  <div id="adminStationSummary"><em>Ch∆∞a t·∫£i d·ªØ li·ªáu...</em></div>
</div>

<!-- ü§ñ AI Suggest -->
<div class="card">
  <h2>‚ö° AI G·ª£i √Ω tr·∫°m l·∫•y pin</h2>
  <label>Lo·∫°i pin:</label>
  <select id="aiBatteryType">
    <option value="Li-ion">Li-ion</option>
    <option value="LFP">LFP</option>
  </select>

  <label>S·ªë tr·∫°m c·∫ßn ƒë·ªÅ xu·∫•t:</label>
  <input type="number" id="topN" value="3" min="1" max="10" />

  <button id="btnAISuggest">G·ªçi AI g·ª£i √Ω</button>

  <h3>K·∫øt qu·∫£:</h3>
  <pre id="result">Ch∆∞a c√≥ d·ªØ li·ªáu</pre>
</div>

<script>
/** ==============================
 *  C·∫§U H√åNH & TR·∫†NG TH√ÅI TO√ÄN C·ª§C
 *  ============================== */
const BASE_URL = window.location.origin + "/webAPI";

// ‚ùó KH√îNG D√ôNG localStorage n·ªØa ‚Üí ch·ªâ gi·ªØ trong b·ªô nh·ªõ
let currentUser = null;

// ===== Helpers =====
const $ = (id)=>document.getElementById(id);
const setText = (id, text)=>{ const el=$(id); if(el) el.textContent = text; };
const show = (id, yes)=>{ const el=$(id); if(!el) return; el.classList.toggle('hide', !yes); };
const authHeader = ()=> currentUser?.token ? {"Authorization": "Bearer "+currentUser.token} : {};

const stationsCache = { list: [], loaded: false };

async function ensureStations(){
  if(stationsCache.loaded && stationsCache.list.length) return stationsCache.list;
  try{
    const res = await fetch(`${BASE_URL}/api/getstations`);
    const data = await res.json();
    const rows = (data?.data)||[];
    stationsCache.list = rows.map(r=>({ id: r.Station_ID, name: r.Name }));
    stationsCache.loaded = true;
    return stationsCache.list;
  }catch(_){
    stationsCache.list = [];
    stationsCache.loaded = true;
    return [];
  }
}

function buildStationSelectHtml(requestId){
  const opts = stationsCache.list.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
  return `<select class="admin-station" id="respondStation-${requestId}">
            <option value="">-- Ch·ªçn tr·∫°m ph·∫£n h·ªìi --</option>
            ${opts}
          </select>`;
}

function whoami(){
  const info = currentUser ? {
    id: currentUser.id,
    fullName: currentUser.fullName,
    role: currentUser.role,
    tokenPreview: currentUser.token?.slice(0,20)+"‚Ä¶"
  } : 'Ch∆∞a ƒëƒÉng nh·∫≠p.';
  $("whoami").textContent = typeof info==='string'? info : JSON.stringify(info, null, 2);
  $("pillRoleText").textContent = currentUser?.role || 'Guest';
}

function routeByRole(){
  const role = (currentUser?.role||'').toLowerCase();
  const isManager = role === 'manager';
  const isAdmin   = role === 'admin';
  const isDriver  = role === 'driver';

  show('areaDriverGuest', !(isManager||isAdmin));
  show('areaManager', isManager);
  show('areaAdmin', isAdmin);

  // ·∫®n/hi·ªán card Li√™n k·∫øt xe theo vai tr√≤
  const linkCard = $("linkVehicleCard");
  linkCard?.classList.toggle("hide", !isDriver);

  if(isDriver){
    loadPackages();
    loadBookingOptions();
    loadBookings();
  } else if(isManager){
    loadMgrPending();
  } else if(isAdmin){
    loadAdminPending();
    loadAdminStationSummary(); // th·ªëng k√™ pin theo tr·∫°m
  } else {
    loadPackages();
  }
}

/** ===================
 *  AUTH (KH√îNG L∆ØU LS)
 *  =================== */
$("btnLogin").addEventListener("click", async ()=>{
  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value.trim();
  const resBox = $("loginResult");
  if(!email || !password){ resBox.textContent = "Nh·∫≠p ƒë·∫ßy ƒë·ªß email + m·∫≠t kh·∫©u!"; return; }

  try {
    const res = await fetch(`${BASE_URL}/api/login`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({email,password})
    });
    const data = await res.json();
    if(data.status==="success"){
      currentUser = { id:data.user.id, fullName:data.user.fullName, role:data.user.role, token:data.token };
      resBox.textContent = `‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!\nUser: ${currentUser.fullName}\nRole: ${currentUser.role}`;
      whoami();
      routeByRole();
    } else {
      resBox.textContent = "‚ùå "+ (data.message||'Login failed');
    }
  } catch(err){ resBox.textContent = "‚ùå "+ err; }
});

$("btnLogout").addEventListener("click", ()=>{
  currentUser = null; // ‚ùó clear in-memory
  alert("‚úÖ B·∫°n ƒë√£ ƒëƒÉng xu·∫•t!");
  whoami();
  routeByRole();
});

// Demo pills (local testing only) ‚Äî KH√îNG d√πng localStorage
$("btnSwitchToDriver").onclick=()=>{ currentUser={id:1,fullName:'Tester',role:'Driver',token:currentUser?.token||''}; whoami(); routeByRole(); };
$("btnSwitchToManager").onclick=()=>{ currentUser={id:2,fullName:'Manager Demo',role:'Manager',token:currentUser?.token||''}; whoami(); routeByRole(); };
$("btnSwitchToAdmin").onclick=()=>{ currentUser={id:3,fullName:'Admin Demo',role:'Admin',token:currentUser?.token||''}; whoami(); routeByRole(); };

/** ============================
 *  DRIVER / GUEST FEATURES
 *  ============================ */
async function loadPackages(){
  const container = $("packageContainer"); if(!container) return;
  try{
    const res = await fetch(`${BASE_URL}/api/getpackages`);
    const data = await res.json();
    container.innerHTML="";
    if(!Array.isArray(data) || data.length===0){ container.textContent="Kh√¥ng c√≥ g√≥i pin"; return; }
    data.forEach(pkg=>{
      const div = document.createElement("div");
      div.className="package-card";
      div.innerHTML=`
        <h3>${pkg.name}</h3>
        <p>${pkg.description||''}</p>
        <p class="price">${Number(pkg.price).toLocaleString("vi-VN")} VNƒê / th√°ng</p>`;
      if(currentUser && currentUser.role?.toLowerCase()==="driver"){
        const btn = document.createElement("button");
        btn.textContent="Mua ngay";
        btn.onclick=()=> buyPackage(pkg.packageId, pkg.price);
        div.appendChild(btn);
      }
      container.appendChild(div);
    });
  }catch(err){ container.textContent="‚ùå L·ªói: "+err; }
}

function buyPackage(packageId, amount){
  if(!currentUser || !currentUser.token){ alert("‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p"); return; }
  const url = `${BASE_URL}/api/payment?userId=${currentUser.id}&packageId=${packageId}&amount=${Math.round(amount)}&orderType=buyPackage`;
  window.location.href = url;
}

async function loadBookingOptions(){
  const stationSelect = $("bookingStation"); if(!stationSelect) return;
  try{
    const res = await fetch(`${BASE_URL}/api/getstations`);
    const stationsRes = await res.json();
    stationSelect.innerHTML="";
    if(!stationsRes.data || stationsRes.data.length===0){ stationSelect.innerHTML="<option>‚ùå Kh√¥ng c√≥ tr·∫°m</option>"; return; }
    stationsRes.data.forEach(st=>{
      const opt=document.createElement("option");
      opt.value=st.Station_ID; opt.textContent=st.Name; stationSelect.appendChild(opt);
    });
  }catch(err){ stationSelect.innerHTML="<option>‚ùå L·ªói t·∫£i tr·∫°m</option>"; }
}

$("btnBooking").addEventListener("click", async () => {
  const resultBox = $("bookingResult");
  if (!currentUser || !currentUser.token) { alert("‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p"); return; }

  const batteryType = $("batteryType").value;
  const stationSelect = $("bookingStation");
  const bookingTime = $("bookingTime").value;
  if (!batteryType || !stationSelect.value || !bookingTime) { resultBox.textContent = "‚ö†Ô∏è ƒêi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!"; return; }
  const stationName = stationSelect.options[stationSelect.selectedIndex].text;

  try {
    const res = await fetch(`${BASE_URL}/api/secure/booking`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeader() },
      body: JSON.stringify({ stationName, batteryModel: batteryType, bookingTime })
    });
    const data = await res.json();
    if (res.ok) { resultBox.textContent = "‚úÖ ƒê·∫∑t tr∆∞·ªõc th√†nh c√¥ng!\n" + JSON.stringify(data, null, 2); loadBookings(); }
    else { resultBox.textContent = "‚ùå " + (data.error || JSON.stringify(data)); }
  } catch (err) { resultBox.textContent = "‚ùå " + err; }
});

$("btnReloadBookings").addEventListener("click", loadBookings);

async function loadBookings(){
  const container = $("bookingsContainer"); if(!container) return;
  if (!currentUser || !currentUser.token) { container.innerHTML = "<em>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch.</em>"; return; }
  container.innerHTML = "<em>ƒêang t·∫£i...</em>";
  try {
    const res = await fetch(`${BASE_URL}/api/secure/getBookings`, { headers: { ...authHeader() } });
    const text = await res.text();
    if (!text || !text.trim()) { container.innerHTML = `<span style="color:#c00">‚ùå Empty response (HTTP ${res.status})</span>`; return; }
    let data; try { data = JSON.parse(text); } catch (e) { container.innerHTML = `<span style="color:#c00">‚ùå Non-JSON: ${text.slice(0,200)}</span>`; return; }
    if (!res.ok) { container.innerHTML = `<span style="color:#c00">‚ùå ${data.error || 'L·ªói t·∫£i danh s√°ch'}</span>`; return; }
    renderBookings(container, Array.isArray(data) ? data : []);
  } catch (err) { container.innerHTML = `<span style="color:#c00">‚ùå ${err}</span>`; }
}

function renderBookings(container, items){
  if (!items.length) { container.innerHTML = "<em>Ch∆∞a c√≥ ƒë·∫∑t ch·ªó n√†o.</em>"; return; }
  const rows = items.map((bk) => {
    const id = bk.bookingId ?? "";
    const stationName = bk.stationName ?? "";
    const csName = bk.chargingStationName ?? "";
    const slotCode = bk.slotCode ?? (bk.slotId ?? "");
    const modelReq = bk.batteryModelRequested ?? bk.batteryRequest ?? "";
    const status = bk.status ?? "";
    const t1 = bk.bookingTime ? fmtTime(bk.bookingTime) : "";
    const t2 = bk.expiredDate ? fmtTime(bk.expiredDate) : "";
    const pkg = bk.packageName ?? "";
    return `
      <tr>
        <td class="code">${id}</td>
        <td>${stationName || "-"}</td>
        <td>${csName || "-"}</td>
        <td class="code">${slotCode || "-"}</td>
        <td>${modelReq || "-"}</td>
        <td><span class="badge">${status}</span></td>
        <td class="code">${t1}</td>
        <td class="code">${t2}</td>
        <td>${pkg || "-"}</td>
      </tr>`;
  }).join("");

  container.innerHTML = `
    <div style="overflow:auto">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Tr·∫°m</th>
            <th>Charging Station</th>
            <th>Slot</th>
            <th>Model y√™u c·∫ßu</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Th·ªùi gian</th>
            <th>H·∫øt h·∫°n</th>
            <th>G√≥i</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function fmtTime(s){
  try {
    if (s.includes('T')) { const d=new Date(s); if(!isNaN(d.getTime())) return d.toLocaleString('vi-VN'); }
    const s2=s.replace(' ','T'); const d2=new Date(s2); if(!isNaN(d2.getTime())) return d2.toLocaleString('vi-VN');
  } catch(_) {}
  return s;
}

/** ======================
 *  LINK VEHICLE (Driver)
 *  ====================== */
const carDocInput    = $("carDocInput");
const carDocPreview  = $("carDocPreview");
const linkVehicleRes = $("linkVehicleResult");

carDocInput?.addEventListener("change", () => {
  const f = carDocInput.files?.[0];
  if (!f) { carDocPreview.style.display = "none"; carDocPreview.src = ""; return; }
  const url = URL.createObjectURL(f);
  carDocPreview.src = url;
  carDocPreview.style.display = "block";
});

$("btnClearVehicle")?.addEventListener("click", () => {
  if (carDocInput) carDocInput.value = "";
  if (carDocPreview) { carDocPreview.src = ""; carDocPreview.style.display = "none"; }
  if (linkVehicleRes) linkVehicleRes.textContent = "";
});

$("btnLinkVehicle")?.addEventListener("click", async () => {
  if (!currentUser || !currentUser.token) { alert("‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p v·ªõi vai tr√≤ Driver."); return; }
  if ((currentUser.role || "").toLowerCase() !== "driver") { alert("‚ö†Ô∏è Ch·ªâ Driver m·ªõi ƒë∆∞·ª£c li√™n k·∫øt xe."); return; }

  const file = carDocInput?.files?.[0];
  if (!file) { linkVehicleRes.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn ·∫£nh c√† v·∫πt xe."; return; }
  if (file.size > 5 * 1024 * 1024) { linkVehicleRes.textContent = "‚ö†Ô∏è ·∫¢nh v∆∞·ª£t qu√° 5MB."; return; }

  linkVehicleRes.textContent = "‚è≥ ƒêang t·∫£i l√™n v√† x·ª≠ l√Ω OCR...";

  try {
    const fd = new FormData();
    fd.append("carDoc", file);

    const res = await fetch(`${BASE_URL}/api/secure/linkVehicle`, {
      method: "POST",
      headers: { ...authHeader() },
      body: fd
    });

    const text = await res.text();
    let data; try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!res.ok || data.status === "error") {
      const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
      linkVehicleRes.textContent = "‚ùå " + msg + (data.debug ? ("\n\nDebug:\n" + JSON.stringify(data.debug, null, 2)) : "");
      return;
    }

    const show = {
      status: data.status,
      message: data.message,
      detectedModel: data.detectedModel,
      ownerFromOCR: data.owner,
      savedVehicle: data.data || null
    };
    linkVehicleRes.textContent = "‚úÖ Th√†nh c√¥ng:\n" + JSON.stringify(show, null, 2);

  } catch (err) {
    linkVehicleRes.textContent = "‚ùå " + err;
  }
});

/** ======================
 *  MANAGER FEATURES
 *  ====================== */
$("btnMgrSend").addEventListener('click', async ()=>{
  if(!currentUser?.token) { alert('‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  const stationName = $("mgrStationName").value.trim();
  const batteryName = $("mgrBatteryName").value.trim();
  const qtyGood = Number($("mgrQtyGood").value||0);
  const qtyAverage = Number($("mgrQtyAvg").value||0);
  const qtyBad = Number($("mgrQtyBad").value||0);
  if(!stationName || !batteryName){ $("mgrResult").textContent = '‚ö†Ô∏è Nh·∫≠p ƒë·ªß t√™n tr·∫°m v√† lo·∫°i pin'; return; }
  try{
    const form = new URLSearchParams();
    form.append('stationName', stationName);
    form.append('batteryName', batteryName);
    form.append('qtyGood', String(qtyGood));
    form.append('qtyAverage', String(qtyAverage));
    form.append('qtyBad', String(qtyBad));
    const res = await fetch(`${BASE_URL}/api/secure/dispatchRequest`, { method:'POST', headers:{ ...authHeader(), 'Content-Type':'application/x-www-form-urlencoded' }, body: form.toString() });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); } catch{ data = { raw:text }; }
    if(res.ok && data.success){ $("mgrResult").textContent = '‚úÖ T·∫°o request th√†nh c√¥ng: #' + data.requestId; loadMgrPending(); }
    else { $("mgrResult").textContent = '‚ùå ' + (data.message || text); }
  }catch(err){ $("mgrResult").textContent = '‚ùå ' + err; }
});

$("btnMgrReload").addEventListener('click', loadMgrPending);

async function loadMgrPending(){
  const box = $("mgrPending");
  box.innerHTML = '<em>ƒêang t·∫£i...</em>';
  try{
    const res = await fetch(`${BASE_URL}/api/secure/dispatchPending`, { headers:{ ...authHeader() } });
    const text = await res.text();

    if (!text || !text.trim()) { box.innerHTML = `<span style="color:#c00">‚ùå Empty response (HTTP ${res.status})</span>`; return; }

    let data;
    try { data = JSON.parse(text); }
    catch { box.innerHTML = `<span style="color:#c00">‚ùå Non-JSON: ${text.slice(0,200)}</span>`; return; }

    if(!res.ok){ box.innerHTML = `<span style="color:#c00">‚ùå ${(data && (data.message || data.error)) || 'L·ªói t·∫£i'}</span>`; return; }

    // üëá Cho ph√©p Manager x√°c nh·∫≠n khi status = Preparing
    renderDispatchTable(box, Array.isArray(data) ? data : [], { showAdminActions:false, showManagerConfirm:true });
  }catch(err){
    box.innerHTML = `<span style="color:#c00">‚ùå ${err}</span>`;
  }
}

function wireManagerConfirmButtons(){
  const container = $("mgrPending");
  container.querySelectorAll('button[data-action="confirm-received"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const dispatchId = btn.getAttribute('data-id');
      await managerConfirmReceived(dispatchId);
    });
  });
}

async function managerConfirmReceived(dispatchId){
  if(!currentUser?.token) { alert('‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  if(!dispatchId){ return; }

  if(!confirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n pin cho request #${dispatchId}?`)) return;

  try{
    // ‚úÖ Backend y√™u c·∫ßu role Manager v√† x√°c th·ª±c tr·∫°m Request
    const form = new URLSearchParams();
    form.append('dispatchId', String(dispatchId));

    const res = await fetch(`${BASE_URL}/api/secure/dispatchConfirm`, {
      method:'POST',
      headers:{ ...authHeader(), 'Content-Type':'application/x-www-form-urlencoded' },
      body: form.toString()
    });

    const text = await res.text();
    let data; try{ data = JSON.parse(text); } catch { data = { raw:text }; }

    if(res.ok && data.success){
      alert('‚úÖ ƒê√£ x√°c nh·∫≠n nh·∫≠n pin & ho√†n t·∫•t ƒëi·ªÅu ph·ªëi!');
      loadMgrPending();
    }else{
      alert('‚ùå ' + (data.message || text));
    }
  }catch(err){
    alert('‚ùå ' + err);
  }
}

/** ======================
 *  ADMIN FEATURES
 *  ====================== */
$("btnAdminReload").addEventListener('click', loadAdminPending);
$("btnAdminSummaryReload").addEventListener('click', loadAdminStationSummary);

async function loadAdminPending(){
  const box = $("adminPending"); box.innerHTML = '<em>ƒêang t·∫£i...</em>';
  await ensureStations();
  try{
    const res = await fetch(`${BASE_URL}/api/secure/admindispatchPending`, { headers:{ ...authHeader() } });
    const data = await res.json();
    if(!res.ok){ box.innerHTML = `<span style="color:#c00">‚ùå ${(data&&data.message)||'L·ªói t·∫£i'}</span>`; return; }
    renderDispatchTable(box, data, { showAdminActions:true });
    // wireAdminActionButtons() s·∫Ω ƒë∆∞·ª£c g·ªçi ngay trong renderDispatchTable
  }catch(err){ box.innerHTML = `<span style="color:#c00">‚ùå ${err}</span>`; }
}

function renderDispatchTable(container, items, opts){
  // opts:
  //   - showAdminActions: boolean
  //   - showManagerConfirm: boolean
  if(!Array.isArray(items) || !items.length){
    container.innerHTML = '<em>Kh√¥ng c√≥ request n√†o.</em>';
    return;
  }
  const actionTh = (opts.showAdminActions || opts.showManagerConfirm) ? '<th>Thao t√°c</th>' : '';

  const rows = items.map((it)=>{
    const requestId     = it.requestId ?? it.dispatchId ?? '';
    const reqName       = it.stationRequestName ?? it.stationRequest ?? it.stationRequest_Name ?? '-';
    const resName       = it.stationRespondName ?? it.stationRespond ?? it.stationRespond_Name ?? '-';
    const batteryName   = it.batteryName ?? it.battery ?? it.batteryType ?? '-';
    const qtyGood       = it.qtyGood ?? it.quantityGood ?? it.Quantity_Type_Good ?? 0;
    const qtyAverage    = it.qtyAverage ?? it.quantityAverage ?? it.Quantity_Type_Average ?? 0;
    const qtyBad        = it.qtyBad ?? it.quantityBad ?? it.Quantity_Type_Bad ?? 0;
    const status        = (it.status ?? '').toString();
    const reqTime       = it.requestTime ? fmtTime(it.requestTime) : (it.Request_Time ? fmtTime(it.Request_Time) : '-');
    const resTime       = it.respondTime ? fmtTime(it.respondTime) : (it.Respond_Time ? fmtTime(it.Respond_Time) : '-');

    // ‚ö†Ô∏è C·ªù t·ª´ BE cho Manager ƒë·ªÉ bi·∫øt m√¨nh l√† Request hay Respond
    const isMyReq = it.isMyStationRequest === true || it.isMyStationRequest === 1 || it.isMyStationRequest === 'true';
    // const isMyRes = it.isMyStationRespond === true || it.isMyStationRespond === 1 || it.isMyStationRespond === 'true';

    // Manager: ch·ªâ hi·ªán Confirm khi l√† tr·∫°m Request & ƒëang Preparing
    const managerButtons = (opts.showManagerConfirm && isMyReq && status.toLowerCase()==='preparing')
      ? `<div class="stack">
           <button class="small approve" data-action="confirm-received" data-id="${requestId}">
             Confirm ƒë√£ nh·∫≠n
           </button>
         </div>`
      : '';

    // Admin: Approve/Cancel (Approve ‚Üí Preparing)
    const adminButtons = opts.showAdminActions
      ? `<div class="stack">
           ${buildStationSelectHtml(requestId)}
           <div class="row">
             <button class="small approve" data-action="approve" data-id="${requestId}">Approve</button>
             <button class="small cancel"  data-action="cancel"  data-id="${requestId}">Cancel</button>
           </div>
         </div>`
      : '';

    const actionCells = (opts.showAdminActions || opts.showManagerConfirm)
      ? `<td>${adminButtons || managerButtons || ''}</td>`
      : '';

    return `<tr>
      <td class="code">${requestId}</td>
      <td>${reqName}</td>
      <td>${resName}</td>
      <td>${batteryName}</td>
      <td class="code">${qtyGood}</td>
      <td class="code">${qtyAverage}</td>
      <td class="code">${qtyBad}</td>
      <td><span class="badge">${status}</span></td>
      <td class="code">${reqTime}</td>
      <td class="code">${resTime}</td>
      ${actionCells}
    </tr>`;
  }).join('');

  container.innerHTML = `
    <div style="overflow:auto">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Tr·∫°m y√™u c·∫ßu</th>
            <th>Tr·∫°m ph·∫£n h·ªìi</th>
            <th>Lo·∫°i pin</th>
            <th>Good</th><th>Average</th><th>Bad</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Th·ªùi gian y√™u c·∫ßu</th>
            <th>Th·ªùi gian ph·∫£n h·ªìi</th>
            ${actionTh}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  if(opts.showAdminActions)   wireAdminActionButtons();
  if(opts.showManagerConfirm) wireManagerConfirmButtons();
}

function wireAdminActionButtons(){
  const container = $("adminPending");
  container.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const requestId = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action'); // approve | cancel
      await approveOrCancelRequest(requestId, action);
    });
  });
}

async function approveOrCancelRequest(requestId, action){
  if(!currentUser?.token) { alert('‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p'); return; }
  if(!requestId || !action) return;

  let stationRespondName = '';
  if(action === 'approve'){
    const sel = document.getElementById(`respondStation-${requestId}`);
    stationRespondName = sel?.value?.trim() || '';
    if(!stationRespondName){
      alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn tr·∫°m ph·∫£n h·ªìi tr∆∞·ªõc khi Approve.');
      return;
    }
  }

  if(!confirm(`${action==='approve'?'Duy·ªát':'H·ªßy'} request #${requestId}?`)) return;

  try{
    const form = new URLSearchParams();
    form.append('requestId', String(requestId));
    form.append('action', action);
    if(action==='approve') form.append('stationRespondName', stationRespondName);

    const res = await fetch(`${BASE_URL}/api/secure/dispatchApprove`, {
      method:'POST',
      headers:{ ...authHeader(), 'Content-Type':'application/x-www-form-urlencoded' },
      body: form.toString()
    });
    const data = await res.json();

    if(res.ok && data.success){
      alert(`‚úÖ ${action==='approve'?'Set PREPARING':'Cancelled'}!`);
      loadAdminPending();
    }else{
      alert('‚ùå ' + (data.message || 'Thao t√°c th·∫•t b·∫°i'));
    }
  }catch(err){
    alert('‚ùå ' + err);
  }
}

/** ==============================
 *  ü§ñ AI Suggest
 *  ============================== */
$("btnAISuggest").addEventListener("click", callAISuggestion);

async function callAISuggestion() {
  const batteryType = $("aiBatteryType").value;
  const topN = parseInt($("topN").value);
  const token = currentUser?.token || "";

  try{
    const res = await fetch(`${BASE_URL}/api/secure/suggestStation`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...authHeader()
      },
      body: JSON.stringify({ batteryType, topN })
    });
    const text = await res.text();
    $("result").textContent = text || "(empty)";
  }catch(err){
    $("result").textContent = "‚ùå " + err;
  }
}

/** ==============================
 *  üìä ADMIN ‚Äî TH·ªêNG K√ä PIN THEO TR·∫†M
 *  ============================== */
$("btnAdminSummaryReload").addEventListener("click", loadAdminStationSummary);

async function loadAdminStationSummary() {
  const box = $("adminStationSummary");
  box.innerHTML = "<em>ƒêang t·∫£i d·ªØ li·ªáu...</em>";

  if (!currentUser || !currentUser.token) {
    box.innerHTML = "<span style='color:#c00'>‚ö†Ô∏è C·∫ßn ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Admin!</span>";
    return;
  }

  try {
    const res = await fetch(`${BASE_URL}/api/secure/getStationBatteryReport`, { headers: { ...authHeader() } });
    const text = await res.text();
    if (!text.trim()) {
      box.innerHTML = `<span style="color:#c00">‚ùå Empty response (HTTP ${res.status})</span>`;
      return;
    }

    let data;
    try { data = JSON.parse(text); } 
    catch { box.innerHTML = `<span style="color:#c00">‚ùå Invalid JSON: ${text.slice(0,200)}</span>`; return; }

    if (data.status !== "success") {
      box.innerHTML = `<span style="color:#c00">‚ö†Ô∏è ${data.message || "Kh√¥ng c√≥ d·ªØ li·ªáu"}</span>`;
      return;
    }

    const rows = data.data;
    if (!rows.length) {
      box.innerHTML = "<em>Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™.</em>";
      return;
    }

    const html = `
      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>Tr·∫°m</th>
              <th>Lo·∫°i pin</th>
              <th>Good</th>
              <th>Average</th>
              <th>Weak</th>
              <th>Below75</th>
              <th>T·ªïng</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${r.stationName || r.StationName || '-'}</td>
                <td>${r.batteryType || r.BatteryType || '-'}</td>
                <td>${r.Good ?? 0}</td>
                <td>${r.Average ?? 0}</td>
                <td>${r.Weak ?? 0}</td>
                <td>${r.Below75 ?? 0}</td>
                <td>${r.Total ?? 0}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = `<span style="color:#c00">‚ùå ${err}</span>`;
  }
}

/** ===== Boot ===== */
whoami();
routeByRole();
</script>
</body>
</html>
