<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Admin DASHBOARD</title>
	<style>
		body{font-family:Segoe UI,Arial,sans-serif;padding:18px;background:#f6f7fb}
		h1{margin:0 0 12px}
		.controls{display:flex;gap:8px;margin-bottom:12px}
		.panel{background:#fff;border-radius:6px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
		table{width:100%;border-collapse:collapse}
		th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
		input[type=text],input[type=number]{padding:6px;border:1px solid #ddd;border-radius:4px}
		.small{width:120px}
		.muted{color:#666}
		.btn{padding:6px 10px;border-radius:4px;border:0;cursor:pointer}
		.btn-primary{background:#1976d2;color:#fff}
		.btn-danger{background:#c62828;color:#fff}
	</style>
</head>
<body>
	<h1>Admin — CRUD Stations</h1>

	<div class="controls">
		<input id="newName" placeholder="Station name" style="width:320px" />
		<input id="newAddress" placeholder="Address" style="width:420px" />
		<button id="createBtn" class="btn btn-primary">Create Station</button>
		<button id="refreshBtn" class="btn">Refresh</button>
		<div id="status" class="muted" style="margin-left:12px"></div>
	</div>

	<!-- Detail modal (hidden by default) -->
	<div id="detailModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:9999">
		<div style="background:#fff;padding:14px;border-radius:8px;max-width:900px;width:95%;max-height:90%;overflow:auto">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
				<strong id="modalTitle">Station Detail</strong>
				<button id="closeModal" class="btn">Close</button>
			</div>
			<div style="margin-bottom:8px">
				<label>Station name</label><br/>
				<input id="modalName" style="width:60%;padding:6px;margin-top:4px" />
			</div>
			<div style="margin-bottom:12px">
				<label>Address</label><br/>
				<input id="modalAddress" style="width:80%;padding:6px;margin-top:4px" />
			</div>
			<div id="modalCsContainer">
				<!-- Charging stations table will be injected here -->
			</div>
			<div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
				<button id="saveStationBtn" class="btn btn-primary">Save Station</button>
				<button id="openAddCS" class="btn">Add Charging Station</button>
			</div>
			<!-- add CS form (hidden) -->
			<div id="addCSForm" style="display:none;margin-top:12px;padding:10px;border:1px dashed #ddd;border-radius:6px">
				<input id="csName" placeholder="CS name" style="width:240px;margin-right:8px" />
				<input id="csCap" type="number" placeholder="Cap" style="width:80px;margin-right:8px" />
				<select id="csType" style="width:140px;margin-right:8px">
					<option value="">--</option>
					<option value="Lithium-ion">Lithium-ion</option>
					<option value="LFP">LFP</option>
				</select>
				<select id="csPower" style="width:120px;margin-right:8px">
					<option value="">--</option>
					<option value="5.0">5.0 kW</option>
					<option value="3.5">3.5 kW</option>
				</select>
				<button id="createCSBtn" class="btn btn-primary">Save CS</button>
				<button id="cancelCSBtn" class="btn">Cancel</button>
			</div>
		</div>
	</div>

	<div class="panel">
		<div id="stationsContainer">Loading stations…</div>
	</div>

	<!-- User Management panel -->
	<div class="panel" style="margin-top:20px">
		<h2 style="margin-top:0">USER MANAGEMENT</h2>
		<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
			<div>
				<input id="userSearch" placeholder="Search by name or email" style="width:320px;padding:6px" />
				<select id="roleFilter" style="margin-left:8px;padding:6px"><option value="">All Roles</option><option value="Staff">Staff</option><option value="Admin">Admin</option></select>
				<button id="filterUsers" class="btn">Filter</button>
			</div>
			<div>
				<button id="createStaffBtn" class="btn btn-primary">Create Staff</button>
			</div>
		</div>
		<div id="usersContainer">Loading users…</div>
	</div>

	<!-- User modal -->
	<div id="userModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:10000">
		<div style="background:#fff;padding:14px;border-radius:8px;max-width:640px;width:95%">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
				<strong id="userModalTitle">Create Staff</strong>
				<button id="closeUserModal" class="btn">Close</button>
			</div>
			<div style="margin-bottom:8px"><label>Full name</label><br/><input id="uFullName" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Email</label><br/><input id="uEmail" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Phone</label><br/><input id="uPhone" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Role</label><br/>
				<select id="uRole" style="width:100%;padding:6px"><option value="Staff">Staff</option><option value="Admin">Admin</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Station (required for Staff)</label><br/>
				<select id="uStationId" style="width:100%;padding:6px"><option value="">-- Select station --</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Status</label><br/>
				<select id="uStatus" style="width:100%;padding:6px"><option value="Active">Active</option><option value="Blocked">Blocked</option><option value="">(none)</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Avatar URL</label><br/>
				<div style="border:1px solid #eee;padding:8px;border-radius:6px">
					<label><input type="radio" name="avatarMode" value="url" checked /> Nhập URL từ Internet</label>
					<div style="margin-top:6px"><input id="uAvatar" style="width:100%;padding:6px" placeholder="https://... or leave empty" /></div>
					<div style="margin-top:8px"><label><input type="radio" name="avatarMode" value="upload" /> Upload ảnh từ máy</label>
					<div style="margin-top:6px"><input id="uAvatarFile" type="file" accept="image/*" /></div>
					</div>
					<div style="margin-top:6px"><img id="uAvatarPreview" src="" style="width:80px;height:80px;border-radius:8px;display:inline-block"/></div>
				</div>
			</div>
			<div style="margin-bottom:8px;display:none"><label>Password (leave blank to keep)</label><br/><input id="uPassword" type="password" style="width:100%;padding:6px"/></div>
			<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
				<button id="saveUserBtn" class="btn btn-primary">Save</button>
				<button id="resetPasswordBtn" class="btn" style="display:none">Reset Password</button>
				<button id="deleteUserBtn" class="btn btn-danger" style="display:none">Delete</button>
			</div>
		</div>
	</div>

	<script>
	// Base paths — compute dynamically from current path so admin UI works under different servlet contexts
	// e.g. if served at http://host/<context>/admin then BASE will be http://host/<context>
	const _ctxSegment = (window.location.pathname || '').split('/')[1] || '';
	const _defaultBase = _ctxSegment ? window.location.origin + '/' + _ctxSegment : window.location.origin;
	const BASE = (window.ADMIN_DASHBOARD_URL_BASE && typeof window.ADMIN_DASHBOARD_URL_BASE === 'string') ? window.ADMIN_DASHBOARD_URL_BASE.replace(/\/$/, '') : _defaultBase.replace(/\/$/, '');
		const API_STATIONS_GET = BASE + '/admin/api/stations_with_charging.jsp'; // returns stations with nested ChargingStations
		const API_STATIONS_CRUD = BASE + '/api/admin/station'; // admin servlet handles create/update/delete (requires session)
		const API_CS = BASE + '/admin/api/charging_stations'; // servlet for charging station CRUD (GET/POST/DELETE)

		document.getElementById('refreshBtn').addEventListener('click', fetchStations);
		document.getElementById('createBtn').addEventListener('click', async () => {
			const name = document.getElementById('newName').value.trim();
			const address = document.getElementById('newAddress').value.trim();
			if (!name) { alert('Name required'); return; }
			setStatus('Creating...');
			try {
				const res = await fetch(API_STATIONS_CRUD, {
					method: 'POST',
					credentials: 'include',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ Station_ID: 0, Name: name, Address: address })
				});
				if (!res.ok) throw new Error('HTTP ' + res.status);
				setStatus('Created');
				document.getElementById('newName').value = '';
				document.getElementById('newAddress').value = '';
				fetchStations();
			} catch (err) { setStatus('Create failed: ' + err); }
		});

		function setStatus(msg){ document.getElementById('status').innerText = msg || ''; }

		async function fetchStations(){
			setStatus('Loading...');
			try {
				const r = await fetch(API_STATIONS_GET, { credentials: 'include' });
				if (!r.ok) throw new Error('HTTP ' + r.status);
				const stations = await r.json();
				window._stations = stations || [];
				renderStations(window._stations);
				setStatus('Loaded ' + (stations.length||0) + ' stations');
			} catch (err) {
				setStatus('Error: ' + err);
				document.getElementById('stationsContainer').innerHTML = '<div class="muted">Error loading stations: '+err+'</div>';
			}
		}

		// when role changes, show/hide station selector (station only for Staff)
		document.addEventListener('DOMContentLoaded', function() {
			const roleSel = document.getElementById('uRole');
			if (!roleSel) return;
			const stationRow = document.getElementById('uStationId') ? document.getElementById('uStationId').parentElement : null;
			roleSel.addEventListener('change', function() {
				try {
					const v = (roleSel.value||'').toString().toLowerCase();
					if (stationRow) stationRow.style.display = (v === 'staff') ? '' : 'none';
				} catch(e) {}
			});
		});

		function renderStations(stations){
			const cont = document.getElementById('stationsContainer');
			if (!Array.isArray(stations) || stations.length === 0) { cont.innerHTML = '<div class="muted">No stations found</div>'; return; }

			let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Address</th><th>Totals</th><th>Actions</th></tr></thead><tbody>';
			stations.forEach(s => {
				const id = s.Station_ID || s.StationId || s.id || s.ID;
				const name = s.Name || s.name || '';
				const addr = s.Address || s.address || '';
				const cs = Array.isArray(s.ChargingStations) ? s.ChargingStations : [];
				const totalSlots = cs.reduce((sum,c)=> sum + (c.Slot_Capacity||0), 0);
				const totalPower = cs.reduce((sum,c)=> sum + parseFloat((c.Power_Rating||'0').toString().replace(/[^0-9.]/g,'' ) || 0), 0);

				html += `<tr data-id="${id}">`;
				html += `<td>${id}</td>`;
				html += `<td><input class="edit-name" value="${escapeHtml(name)}" style="width:260px"/></td>`;
				html += `<td><input class="edit-address" value="${escapeHtml(addr)}" style="width:360px"/></td>`;
				// format totals: slots and total power with unit and labels
				const totalPowerStr = Number(totalPower).toFixed(1).replace(/\.0$/,'');
				html += `<td>Tổng: ${totalSlots} (Slot) / ${totalPowerStr} kW (Tổng Công Suất)</td>`;
				html += `<td><button class="btn btn" data-action="open-detail">Edit</button> <button class="btn btn-primary btn-save">Save</button> <button class="btn btn-danger btn-delete">Delete</button> <button class="btn" data-action="toggle-cs">CS</button></td>`;
				html += `</tr>`;

				// inline charging station rows
				html += `<tr class="cs-row" data-parent="${id}" style="display:none"><td colspan="5">`;
				html += `<div style="margin-bottom:8px"><strong>Charging Stations</strong></div>`;
				html += `<table><thead><tr><th>ID</th><th>Name</th><th>Slot Cap</th><th>Type</th><th>Power</th><th>Actions</th></tr></thead><tbody>`;
				cs.forEach(c=>{
					const cid = c.ChargingStation_ID || c.id;
					const curType = (c.Slot_Type||c.slot_type||'') || '';
					const curPower = (c.Power_Rating||c.power_rating||'') || '';
					html += `<tr data-cid="${cid}"><td>${cid}</td><td><input class="cs-name" value="${escapeHtml(c.Name||c.name||'')}"/></td><td><input class="cs-cap" type="number" value="${c.Slot_Capacity||0}" style="width:80px"/></td>`;
					// normalize current power value (strip non-numeric)
					const curPowerVal = (String(curPower).match(/\d+(?:\.\d+)?/) || [''])[0];
					html += `<td><select class="cs-type"><option value="">--</option><option value="Lithium-ion" ${curType==='Lithium-ion'?'selected':''}>Lithium-ion</option><option value="LFP" ${curType==='LFP'?'selected':''}>LFP</option></select></td>`;
					html += `<td><select class="cs-power" style="width:90px"><option value="">--</option><option value="5.0" ${curPowerVal==='5.0'?'selected':''}>5.0 kW</option><option value="3.5" ${curPowerVal==='3.5'?'selected':''}>3.5 kW</option></select></td>`;
					html += `<td><button class="btn btn-primary cs-save">Save</button> <button class="btn btn-danger cs-delete">Delete</button></td></tr>`;
				});
				// add new row
				html += `<tr class="cs-new-row"><td>new</td><td><input class="cs-new-name"/></td><td><input class="cs-new-cap" type="number" value="1" style="width:80px"/></td><td><select class="cs-new-type"><option value="">--</option><option value="Lithium-ion">Lithium-ion</option><option value="LFP">LFP</option></select></td><td><select class="cs-new-power" style="width:90px"><option value="">--</option><option value="5.0">5.0 kW</option><option value="3.5">3.5 kW</option></select></td><td><button class="btn btn-primary cs-create">Add</button></td></tr>`;
				html += `</tbody></table>`;
				html += `</td></tr>`;
			});
			html += '</tbody></table>';
			cont.innerHTML = html;

			attachHandlers();
		}

	// helper: try JSON API then fall back to older form-based servlet if JSON endpoint missing (404)
	async function postChargingStation(body){
	    // try JSON API
	    try {
	        let res = await fetch(API_CS, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
	        if (res.status !== 404) return res;
	        // fallback to form-based servlet(s)
	        const action = (body.action||'create').toLowerCase();
	        const form = new URLSearchParams();
	        form.append('action', action);
	        if (action === 'create'){
	            form.append('stationId', String(body.station_id || body.Station_ID || ''));
	            form.append('name', String(body.name || ''));
	            form.append('slotCapacity', String(body.slot_capacity || body.Slot_Capacity || 0));
	            form.append('slotType', String(body.slot_type || body.Slot_Type || ''));
	            form.append('powerRating', String(body.power_rating != null ? body.power_rating : (body.Power_Rating || 0)));
	            // try /admin/charging first, then /charging (some builds map differently)
	            let res2 = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            if (res2.status === 404) {
	                res2 = await fetch(BASE + '/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            }
	            return res2;
	        } else if (action === 'update'){
	            form.append('chargingStationId', String(body.id || body.ChargingStation_ID || 0));
	            form.append('stationId', String(body.station_id || body.Station_ID || 0));
	            form.append('name', String(body.name || ''));
	            form.append('slotCapacity', String(body.slot_capacity || body.Slot_Capacity || 0));
	            form.append('slotType', String(body.slot_type || body.Slot_Type || ''));
	            form.append('powerRating', String(body.power_rating != null ? body.power_rating : (body.Power_Rating || 0)));
	            let res2 = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            if (res2.status === 404) {
	                res2 = await fetch(BASE + '/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            }
	            return res2;
	        } else {
	            // unknown action — return original response
	            return res;
	        }
	    } catch (err) {
	        // propagate error to caller
	        throw err;
	    }
	}

	function attachHandlers(){

		document.querySelectorAll('button[data-action="toggle-cs"]').forEach(b=> b.addEventListener('click', (e)=>{
				const tr = e.target.closest('tr'); const id = tr.dataset.id;
				const row = document.querySelector(`.cs-row[data-parent="${id}"]`);
				row.style.display = row.style.display === 'none' ? '' : 'none';
			}));

			document.querySelectorAll('.btn-save').forEach(btn => btn.addEventListener('click', async e=>{
				const row = e.target.closest('tr');
				const id = row.dataset.id; const name = row.querySelector('.edit-name').value.trim(); const addr = row.querySelector('.edit-address').value.trim();
				if (!name) { alert('Name required'); return; }
				try {
						const res = await fetch(API_STATIONS_CRUD, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ Station_ID: parseInt(id,10), Name: name, Address: addr }) });
					if (!res.ok) {
						let errText = 'HTTP ' + res.status;
						try { errText = await res.text(); } catch(e) { /* ignore */ }
						throw new Error(errText || ('HTTP '+res.status));
					}
					fetchStations();
				} catch (err) { alert('Update failed: '+err); }
			}));

			document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', async e=>{
				const row = e.target.closest('tr'); const id = row.dataset.id;
				if (!confirm('Delete station '+id+'?')) return;
				try {
					const res = await fetch(API_STATIONS_CRUD + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
					if (!res.ok) {
						let errText = 'HTTP ' + res.status;
						try { errText = await res.text(); } catch(e) { /* ignore */ }
						throw new Error(errText || ('HTTP '+res.status));
					}
					fetchStations();
				} catch (err) { alert('Delete failed: '+err); }
			}));

			// CS handlers
			document.querySelectorAll('.cs-save').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; const parent = tr.closest('.cs-row').dataset.parent;
				const name = tr.querySelector('.cs-name').value.trim(); const cap = parseInt(tr.querySelector('.cs-cap').value||0,10); const type = tr.querySelector('.cs-type').value.trim(); const power = tr.querySelector('.cs-power').value.trim();
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action: 'update', id: cid, station_id: parent, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) {
						// try to extract JSON error message from server for friendlier UI
						let msg = 'HTTP ' + res.status;
						try {
							const errBody = await res.json();
							if (errBody) {
								if (errBody.error) msg = errBody.error;
								else if (errBody.message) msg = errBody.message;
								else msg = JSON.stringify(errBody);
							}
						} catch(e) {
							try { const t = await res.text(); if (t) msg = t; } catch(e2) { /* ignore */ }
						}
						throw new Error(msg);
					}
					fetchStations();
				} catch (err) { alert('CS update failed: '+err); }
			}));

			document.querySelectorAll('.cs-delete').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid;
				if (!confirm('Delete CS '+cid+'?')) return;
				try {
					// try API DELETE first, fall back to form POST delete
					let res = await fetch(API_CS + '?id=' + encodeURIComponent(cid), { method: 'DELETE', credentials: 'include' });
					if (res.status === 404) {
						// fallback to older servlet that expects form params
						const form = new URLSearchParams(); form.append('action','delete'); form.append('id', cid);
						res = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
					}
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations();
				} catch (err) { alert('CS delete failed: '+err); }
			}));

			document.querySelectorAll('.cs-create').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('table').querySelector('.cs-new-row');
				const parentRow = e.target.closest('.cs-row'); const stationId = parentRow.dataset.parent;
				const name = tr.querySelector('.cs-new-name').value.trim(); const cap = parseInt(tr.querySelector('.cs-new-cap').value||0,10); const type = tr.querySelector('.cs-new-type').value.trim(); const power = tr.querySelector('.cs-new-power').value.trim();
				if (!name) { alert('Name required'); return; }
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action:'create', station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations();
				} catch (err) { alert('CS create failed: '+err); }
			}));

			// synchronize type <-> power for inline rows and new rows
			document.querySelectorAll('tr[data-cid], tr.cs-new-row').forEach(row => {
				const typeSel = row.querySelector('.cs-type') || row.querySelector('.cs-new-type');
				const powerSel = row.querySelector('.cs-power') || row.querySelector('.cs-new-power');
				if (!typeSel || !powerSel) return;
				const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
				const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
				typeSel.addEventListener('change', ()=>{
					const p = mapTypeToPower(typeSel.value);
					if (p) powerSel.value = p;
				});
				powerSel.addEventListener('change', ()=>{
					const t = mapPowerToType(powerSel.value);
					if (t) typeSel.value = t;
				});
			});

			// open detail modal
			document.querySelectorAll('button[data-action="open-detail"]').forEach(b=> b.addEventListener('click', (e)=>{
				const tr = e.target.closest('tr'); const id = tr.dataset.id; const station = (window._stations||[]).find(x=>String(x.Station_ID||x.id||x.ID) === String(id));
				if (!station) { alert('Station not found'); return; }
				openDetail(station);
			}));
		}

		function openDetail(station){
			document.getElementById('modalTitle').innerText = 'Station: ' + (station.Station_ID || station.id || '');
			document.getElementById('modalName').value = station.Name || station.name || '';
			document.getElementById('modalAddress').value = station.Address || station.address || '';
			document.getElementById('detailModal').dataset.stationId = station.Station_ID || station.id || '';
			document.getElementById('detailModal').style.display = 'flex';
			renderModalCs(station.ChargingStations || []);
			document.getElementById('addCSForm').style.display = 'none';
		}

		function closeDetail(){
			document.getElementById('detailModal').style.display = 'none';
			document.getElementById('addCSForm').style.display = 'none';
		}

		function renderModalCs(list){
			const cont = document.getElementById('modalCsContainer');
			if (!Array.isArray(list) || list.length === 0) { cont.innerHTML = '<div class="muted">No charging stations</div>'; return; }
			let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th>ID</th><th>Name</th><th>Slot Cap</th><th>Type</th><th>Power</th><th>Actions</th></tr></thead><tbody>';
				list.forEach(c=>{
				const curType = (c.Slot_Type||c.slot_type||'') || '';
				const curPower = (c.Power_Rating||c.power_rating||'') || '';
				html += `<tr data-cid="${c.ChargingStation_ID||c.id}"><td>${c.ChargingStation_ID||c.id}</td><td><input class="modal-cs-name" value="${escapeHtml(c.Name||c.name||'')}" style="width:220px"/></td><td><input class="modal-cs-cap" type="number" value="${c.Slot_Capacity||0}" style="width:80px"/></td>`;
				html += `<td><select class="modal-cs-type" style="width:140px"><option value="">--</option><option value="Lithium-ion" ${curType==='Lithium-ion'?'selected':''}>Lithium-ion</option><option value="LFP" ${curType==='LFP'?'selected':''}>LFP</option></select></td>`;
				// normalize power value to numeric string for selection
				const curPowerValModal = (String(curPower).match(/\d+(?:\.\d+)?/) || [''])[0];
				html += `<td><select class="modal-cs-power" style="width:90px"><option value="">--</option><option value="5.0" ${curPowerValModal==='5.0'?'selected':''}>5.0 kW</option><option value="3.5" ${curPowerValModal==='3.5'?'selected':''}>3.5 kW</option></select></td>`;
				html += `<td><button class="btn modal-cs-save">Save</button> <button class="btn btn-danger modal-cs-delete">Delete</button></td></tr>`;
				});
			html += '</tbody></table>';
			cont.innerHTML = html;

			// attach modal CS handlers
			document.querySelectorAll('.modal-cs-save').forEach(btn=> btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; const stationId = document.getElementById('detailModal').dataset.stationId;
				const name = tr.querySelector('.modal-cs-name').value.trim(); const cap = parseInt(tr.querySelector('.modal-cs-cap').value||0,10); const type = tr.querySelector('.modal-cs-type').value.trim(); const power = tr.querySelector('.modal-cs-power').value.trim();
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action:'update', id: cid, station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations(); closeDetail();
				} catch(err){ alert('CS update failed: '+err); }
			}));

			document.querySelectorAll('.modal-cs-delete').forEach(btn=> btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; if (!confirm('Delete CS '+cid+'?')) return;
				try {
					let res = await fetch(API_CS + '?id=' + encodeURIComponent(cid), { method: 'DELETE', credentials: 'include' });
					if (res.status === 404) {
						const form = new URLSearchParams(); form.append('action','delete'); form.append('id', cid);
						res = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
					}
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations(); closeDetail();
				} catch(err){ alert('CS delete failed: '+err); }
			}));

			// synchronize type <-> power inside modal
			const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
			const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
			document.querySelectorAll('select.modal-cs-type').forEach(typeSel => {
				const tr = typeSel.closest('tr');
				const powerSel = tr.querySelector('select.modal-cs-power');
				if (!powerSel) return;
				typeSel.addEventListener('change', ()=>{ const p = mapTypeToPower(typeSel.value); if(p) powerSel.value = p; });
			});
			document.querySelectorAll('select.modal-cs-power').forEach(powerSel => {
				const tr = powerSel.closest('tr');
				const typeSel = tr.querySelector('select.modal-cs-type');
				if (!typeSel) return;
				powerSel.addEventListener('change', ()=>{ const t = mapPowerToType(powerSel.value); if(t) typeSel.value = t; });
			});
		}

		// modal control handlers
		document.getElementById('closeModal').addEventListener('click', closeDetail);

		document.getElementById('saveStationBtn').addEventListener('click', async () => {
			const stationId = document.getElementById('detailModal').dataset.stationId || 0;
			const name = document.getElementById('modalName').value.trim();
			const address = document.getElementById('modalAddress').value.trim();
			if (!name) { alert('Name required'); return; }
			try {
				// admin endpoint expects POST with Station_ID==0 for insert, else update
				const res = await fetch(API_STATIONS_CRUD, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ Station_ID: parseInt(stationId,10), Name: name, Address: address }) });
				if (!res.ok) throw new Error('HTTP '+res.status);
				fetchStations(); closeDetail();
			} catch(err){ alert('Save station failed: '+err); }
		});

		document.getElementById('openAddCS').addEventListener('click', () => {
			document.getElementById('csName').value = '';
			document.getElementById('csCap').value = 1;
			document.getElementById('csType').value = '';
			document.getElementById('csPower').value = '';
			document.getElementById('addCSForm').dataset.stationId = document.getElementById('detailModal').dataset.stationId;
			document.getElementById('addCSForm').dataset.editId = '';
			document.getElementById('addCSForm').style.display = 'block';
		});

		document.getElementById('cancelCSBtn').addEventListener('click', () => { document.getElementById('addCSForm').style.display = 'none'; });

		document.getElementById('createCSBtn').addEventListener('click', async () => {
			const stationId = document.getElementById('addCSForm').dataset.stationId;
			const name = document.getElementById('csName').value.trim(); const cap = parseInt(document.getElementById('csCap').value||0,10);
			const type = document.getElementById('csType').value.trim(); const power = document.getElementById('csPower').value.trim();
			if (!name) { alert('Name required'); return; }
			try {
				// normalize power to numeric and send using helper that falls back to legacy servlet
				const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
				const body = { action: 'create', station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
				const res = await postChargingStation(body);
				if (!res.ok) throw new Error('HTTP '+res.status);
				fetchStations(); document.getElementById('addCSForm').style.display='none'; closeDetail();
			} catch(err){ alert('Create CS failed: '+err); }
		});

		// sync addCSForm type <-> power
		const addType = document.getElementById('csType');
		const addPower = document.getElementById('csPower');
		if (addType && addPower) {
			const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
			const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
			addType.addEventListener('change', ()=>{ const p = mapTypeToPower(addType.value); if(p) addPower.value = p; });
			addPower.addEventListener('change', ()=>{ const t = mapPowerToType(addPower.value); if(t) addType.value = t; });
		}

		function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>\\"]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]; }); }

		// --- User management JS ---
		const API_USERS = BASE + '/api/admin/users';
		const DEFAULT_AVATAR = BASE + '/resources/images/avatar_default.svg';

		function getAuthHeaders(){
			const headers = { 'Content-Type': 'application/json' };
			try {
				const token = localStorage.getItem('adminToken') || '';
				if (token) headers['Authorization'] = 'Bearer ' + token;
			} catch(e) {}
			return headers;
		}

		async function fetchUsers(){
			const q = document.getElementById('userSearch').value.trim();
			const role = document.getElementById('roleFilter').value;
			let url = API_USERS;
			const params = [];
			if (role) params.push('role=' + encodeURIComponent(role));
			if (q) params.push('q=' + encodeURIComponent(q));
			if (params.length) url += '?' + params.join('&');
			try {
				const res = await fetch(url, { method: 'GET', credentials: 'include', headers: getAuthHeaders() });
				if (!res.ok) throw new Error('HTTP ' + res.status);
				const users = await res.json();
				renderUsers(users || []);
			} catch(err){ document.getElementById('usersContainer').innerHTML = '<div class="muted">Error loading users: '+err+'</div>'; }
		}

		function renderUsers(users){
			const c = document.getElementById('usersContainer');
			if (!Array.isArray(users) || users.length === 0) { c.innerHTML = '<div class="muted">No users found</div>'; return; }
			// keep a copy for modal lookups
			window._users = users;
			let html = '<table><thead><tr><th>ID</th><th>Full name</th><th>Email</th><th>Phone</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
			users.forEach(u=>{
				const id = u.id || u.Id || u.ID;
				const avatar = u.avatarUrl || u.avatar || u.Avatar_URL || '';
				const status = (u.status || u.Status || '') + '';
				const role = u.role || u.Role || '';
				// status badge styles
				let badgeColor = '#999'; // pending/none
				if ((status||'').toLowerCase() === 'active') badgeColor = '#2e7d32';
				if ((status||'').toLowerCase() === 'blocked') badgeColor = '#c62828';
				const badgeHtml = `<div style="display:inline-block;margin-left:8px;padding:2px 8px;border-radius:12px;background:${badgeColor};color:#fff;font-size:12px;vertical-align:middle">${escapeHtml(status|| (role? 'Active' : ''))}</div>`;
				const disabledAttr = ((status||'').toLowerCase() === 'blocked') ? 'disabled' : '';
				html += `<tr data-uid="${id}"><td>${id}</td><td><div style="display:flex;align-items:center;gap:8px"><img src="${escapeHtml(avatar || DEFAULT_AVATAR)}" style="width:40px;height:40px;border-radius:50%"/> ${escapeHtml(u.fullName||u.fullname||u.FullName||'')}</div></td><td>${escapeHtml(u.email||'')}</td><td>${escapeHtml(u.phone||'')}</td><td>${escapeHtml(role||'')}${badgeHtml}</td><td><button class="btn" data-action="edit-user" ${disabledAttr}>Edit</button> <button class="btn btn-danger" data-action="delete-user" ${disabledAttr}>Delete</button></td></tr>`;
			});
			html += '</tbody></table>';
			c.innerHTML = html;
			// attach handlers
			document.querySelectorAll('button[data-action="edit-user"]').forEach(b=> b.addEventListener('click', e=>{
				const id = e.target.closest('tr').dataset.uid; const row = e.target.closest('tr');
				const usersList = window._users || [];
				const user = usersList.find(x=> String(x.id||x.ID) === String(id));
				openUserModal(user || { id: id });
			}));
			document.querySelectorAll('button[data-action="delete-user"]').forEach(b=> b.addEventListener('click', async e=>{
				const id = e.target.closest('tr').dataset.uid; if (!confirm('Delete user '+id+'?')) return;
				try { const res = await fetch(API_USERS + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include', headers: getAuthHeaders() }); if (!res.ok) throw new Error('HTTP '+res.status); fetchUsers(); } catch(err){ alert('Delete failed: '+err); }
			}));
		}

		function openUserModal(user){
			document.getElementById('userModalTitle').innerText = user && user.id ? 'Edit User: ' + user.id : 'Create Staff';
			document.getElementById('uFullName').value = user.fullName || user.fullname || '';
			document.getElementById('uEmail').value = user.email || '';
			document.getElementById('uPhone').value = user.phone || '';
			document.getElementById('uRole').value = user.role || 'Staff';
			document.getElementById('userModal').dataset.userId = user.id || '';
			document.getElementById('uStatus').value = user.status || user.Status || '';
			// show inline status notice and disable actions if Blocked or None
			try {
				let notice = document.getElementById('uStatusNotice');
				if (!notice) {
					notice = document.createElement('div');
					notice.id = 'uStatusNotice';
					notice.style.marginTop = '6px';
					notice.style.fontSize = '13px';
					notice.style.color = '#333';
					document.getElementById('uStatus').parentElement.appendChild(notice);
				}
				const st = (user.status || user.Status || '').toString().toLowerCase();
				if (st === 'blocked') {
					notice.innerText = 'Tài khoản này đang bị khóa — không thể thực hiện hành động';
					notice.style.color = '#c62828';
					document.getElementById('saveUserBtn').disabled = true;
					document.getElementById('deleteUserBtn').disabled = true;
					document.getElementById('resetPasswordBtn').disabled = true;
				} else if (!st || st === 'none' || st === '(none)') {
					notice.innerText = 'Tài khoản chưa kích hoạt — hãy yêu cầu hoàn tất đăng ký/verify';
					notice.style.color = '#777';
					document.getElementById('saveUserBtn').disabled = true; // require activation first
					document.getElementById('deleteUserBtn').disabled = false; // allow delete
					document.getElementById('resetPasswordBtn').disabled = true;
				} else {
					notice.innerText = '';
					document.getElementById('saveUserBtn').disabled = false;
					document.getElementById('deleteUserBtn').disabled = false;
					document.getElementById('resetPasswordBtn').disabled = false;
				}
			} catch(e) {}
			// populate station select from loaded stations
			try {
				const sel = document.getElementById('uStationId');
				if (sel) {
					sel.innerHTML = '<option value="">-- Select station --</option>';
					const stations = window._stations || [];
					stations.forEach(s => {
						const id = s.Station_ID || s.StationId || s.id || s.ID;
						const name = s.Name || s.name || ('Station ' + id);
						const opt = document.createElement('option'); opt.value = id; opt.text = name; sel.appendChild(opt);
					});
					// set selected value if present on user
					if (user && (user.stationId || user.Station_ID || user.StationId)) sel.value = user.stationId || user.Station_ID || user.StationId;
				}
			} catch(e) {}
			document.getElementById('uAvatar').value = user.avatarUrl || user.avatar || user.Avatar_URL || '';
			const preview = document.getElementById('uAvatarPreview');
			if (preview) { const val = document.getElementById('uAvatar').value && document.getElementById('uAvatar').value.trim(); preview.src = val ? val : DEFAULT_AVATAR; preview.style.display = 'inline-block'; }
			document.getElementById('deleteUserBtn').style.display = user && user.id ? 'inline-block' : 'none';
			document.getElementById('resetPasswordBtn').style.display = user && user.id ? 'inline-block' : 'none';
			// disable role change if editing an Admin user
			try {
				const roleSel = document.getElementById('uRole');
				if (roleSel) {
					if (user && (user.role||user.Role||'').toString().toLowerCase() === 'admin') {
						roleSel.disabled = true;
						// hide station selector for admins
						document.getElementById('uStationId').parentElement.style.display = 'none';
					} else {
						roleSel.disabled = false;
						document.getElementById('uStationId').parentElement.style.display = '';
					}
				}
			} catch(e) {}
			document.getElementById('userModal').style.display = 'flex';
		}

		document.getElementById('closeUserModal').addEventListener('click', ()=>{ document.getElementById('userModal').style.display = 'none'; });

		document.getElementById('createStaffBtn').addEventListener('click', ()=> openUserModal({}));

		document.getElementById('filterUsers').addEventListener('click', ()=> fetchUsers());

		document.getElementById('uAvatar').addEventListener('input', (e)=>{
			const preview = document.getElementById('uAvatarPreview');
			if (!preview) return;
			const v = e.target.value && e.target.value.trim();
			preview.src = v ? v : DEFAULT_AVATAR;
			preview.style.display = 'inline-block';
		});

		// file input preview
		document.getElementById('uAvatarFile').addEventListener('change', (e)=>{
			const f = e.target.files && e.target.files[0];
			const preview = document.getElementById('uAvatarPreview');
			if (!preview) return;
			if (!f) { preview.src = DEFAULT_AVATAR; return; }
			const reader = new FileReader();
			reader.onload = function(ev){ preview.src = ev.target.result; };
			reader.readAsDataURL(f);
		});

		// switch mode enable/disable
		document.querySelectorAll('input[name="avatarMode"]').forEach(r=> r.addEventListener('change', ()=>{
			const mode = document.querySelector('input[name="avatarMode"]:checked').value;
			document.getElementById('uAvatar').disabled = (mode!=='url');
			document.getElementById('uAvatarFile').disabled = (mode!=='upload');
		}));

		document.getElementById('saveUserBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId || 0;
			const fullName = document.getElementById('uFullName').value.trim();
			const email = document.getElementById('uEmail').value.trim();
			const phone = document.getElementById('uPhone').value.trim();
			const role = document.getElementById('uRole').value;
			const status = document.getElementById('uStatus').value || '';
			const avatar = document.getElementById('uAvatar').value.trim() || '';
			const stationId = document.getElementById('uStationId') ? document.getElementById('uStationId').value : '';
			const password = document.getElementById('uPassword') ? document.getElementById('uPassword').value : '';
			if (!fullName || !email) { alert('Name and email required'); return; }
			try {
				const method = id && Number(id) > 0 ? 'PUT' : 'POST';
				const url = API_USERS;
				// determine avatar mode: url or upload
				const mode = document.querySelector('input[name="avatarMode"]:checked') ? document.querySelector('input[name="avatarMode"]:checked').value : 'url';
				let res;
                    if (mode === 'upload' && document.getElementById('uAvatarFile').files && document.getElementById('uAvatarFile').files.length > 0) {
					const fd = new FormData();
					fd.append('id', Number(id||0));
					fd.append('fullName', fullName);
					fd.append('email', email);
					fd.append('phone', phone);
					fd.append('role', role);
					fd.append('status', status);
					if (stationId) fd.append('stationId', stationId);
					if (password && password.length > 0) fd.append('password', password);
					const file = document.getElementById('uAvatarFile').files[0];
					fd.append('avatarFile', file, file.name);
					// send multipart; do NOT set Content-Type so browser sets boundary
					const headers = getAuthHeaders(); delete headers['Content-Type'];
					res = await fetch(url, { method: method, credentials: 'include', headers: headers, body: fd });
				} else {
					const body = { id: Number(id||0), fullName: fullName, email: email, phone: phone, role: role, status: status, avatarUrl: avatar };
					if (stationId) body.stationId = Number(stationId);
					if (password && password.length > 0) body.password = password;
					res = await fetch(url, { method: method, credentials: 'include', headers: Object.assign({'Content-Type':'application/json'}, getAuthHeaders()), body: JSON.stringify(body) });
				}
				if (!res.ok) throw new Error('HTTP '+res.status);
				document.getElementById('userModal').style.display = 'none';
				fetchUsers();
			} catch(err){
				try {
					const msg = err && err.message ? err.message : String(err);
					const ml = (msg || '').toLowerCase();
					// if server indicates duplicate email or phone, show Vietnamese friendly messages
					if (ml.includes('email') || ml.includes('email đã tồn tại') || ml.includes('không thể tạo staff do email')) {
						alert('Không thể tạo Staff do email đã tồn tại');
					} else if (ml.includes('phone') || ml.includes('số điện thoại') || ml.includes('không thể tạo staff do số điện thoại')) {
						alert('Không thể tạo Staff do số điện thoại đã tồn tại');
					} else {
						alert('Save user failed: ' + msg);
					}
				} catch(e2) { alert('Save user failed: ' + err); }
			}
		});

		document.getElementById('deleteUserBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId; if (!id) return; if (!confirm('Delete user '+id+'?')) return;
			try { const res = await fetch(API_USERS + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include', headers: getAuthHeaders() }); if (!res.ok) throw new Error('HTTP '+res.status); document.getElementById('userModal').style.display = 'none'; fetchUsers(); } catch(err){ alert('Delete failed: '+err); }
		});

		document.getElementById('resetPasswordBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId; if (!id) return; if (!confirm('Reset password for user '+id+' to default?')) return;
			try {
				const defaultPwd = 'ChangeMe123!';
				// set password field and trigger save (PUT)
				document.getElementById('uPassword').value = defaultPwd;
				const res = await fetch(API_USERS, { method: 'PUT', credentials: 'include', headers: Object.assign({'Content-Type':'application/json'}, getAuthHeaders()), body: JSON.stringify({ id: Number(id), password: defaultPwd }) });
				if (!res.ok) throw new Error('HTTP '+res.status);
				alert('Password reset to default: ' + defaultPwd);
				document.getElementById('userModal').style.display = 'none';
				fetchUsers();
			} catch(err){ alert('Reset password failed: '+err); }
		});

		// expose users data for editing handler lookup
		window._users = window._users || [];

		// initial load: stations and users
		fetchStations();
		fetchUsers();
	</script>
</body>
</html>
