<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Admin DASHBOARD</title>
	<style>
		body{font-family:Segoe UI,Arial,sans-serif;padding:18px;background:#f6f7fb}
		h1{margin:0 0 12px}
		.controls{display:flex;gap:8px;margin-bottom:12px}
		.panel{background:#fff;border-radius:6px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
		table{width:100%;border-collapse:collapse}
		th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
		input[type=text],input[type=number]{padding:6px;border:1px solid #ddd;border-radius:4px}
		.small{width:120px}
		.muted{color:#666}
		.btn{padding:6px 10px;border-radius:4px;border:0;cursor:pointer}
		.btn-primary{background:#1976d2;color:#fff}
		.btn-danger{background:#c62828;color:#fff}
	</style>
</head>
<body>
	<h1>Admin ‚Äî CRUD Stations</h1>

	<div class="controls">
		<input id="newName" placeholder="Station name" style="width:320px" />
		<input id="newAddress" placeholder="Address" style="width:420px" />
		<button id="createBtn" class="btn btn-primary">Create Station</button>
		<button id="refreshBtn" class="btn">Refresh</button>
		<div id="status" class="muted" style="margin-left:12px"></div>
	</div>

	<!-- Detail modal (hidden by default) -->
	<div id="detailModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:9999">
		<div style="background:#fff;padding:14px;border-radius:8px;max-width:900px;width:95%;max-height:90%;overflow:auto">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
				<strong id="modalTitle">Station Detail</strong>
				<button id="closeModal" class="btn">Close</button>
			</div>
			<div style="margin-bottom:8px">
				<label>Station name</label><br/>
				<input id="modalName" style="width:60%;padding:6px;margin-top:4px" />
			</div>
			<div style="margin-bottom:12px">
				<label>Address</label><br/>
				<input id="modalAddress" style="width:80%;padding:6px;margin-top:4px" />
			</div>
			<div id="modalCsContainer">
				<!-- Charging stations table will be injected here -->
			</div>
			<div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
				<button id="saveStationBtn" class="btn btn-primary">Save Station</button>
				<button id="openAddCS" class="btn">Add Charging Station</button>
			</div>
			<!-- add CS form (hidden) -->
			<div id="addCSForm" style="display:none;margin-top:12px;padding:10px;border:1px dashed #ddd;border-radius:6px">
				<input id="csName" placeholder="CS name" style="width:240px;margin-right:8px" />
				<input id="csCap" type="number" placeholder="Cap" style="width:80px;margin-right:8px" />
				<select id="csType" style="width:140px;margin-right:8px">
					<option value="">--</option>
					<option value="Lithium-ion">Lithium-ion</option>
					<option value="LFP">LFP</option>
				</select>
				<select id="csPower" style="width:120px;margin-right:8px">
					<option value="">--</option>
					<option value="5.0">5.0 kW</option>
					<option value="3.5">3.5 kW</option>
				</select>
				<button id="createCSBtn" class="btn btn-primary">Save CS</button>
				<button id="cancelCSBtn" class="btn">Cancel</button>
			</div>
		</div>
	</div>

	<div class="panel">
		<div style="margin-bottom:12px">
			<button id="toggleStationsBtn" class="btn btn-primary" style="padding:8px 16px">
				ÔøΩ T·∫£i danh s√°ch tr·∫°m
			</button>
		</div>
		<div id="stationsContainer" style="display:none">
			<!-- Station list will be rendered here -->
		</div>
	</div>

	<!-- User Management panel -->
	<div class="panel" style="margin-top:20px">
		<h2 style="margin-top:0">USER MANAGEMENT</h2>
		<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
			<div>
				<button id="toggleUsersBtn" class="btn btn-primary" style="padding:8px 16px">
					üë• T·∫£i danh s√°ch nh√¢n s·ª±
				</button>
			</div>
			<div id="userControls" style="display:none">
				<input id="userSearch" placeholder="Search by name or email" style="width:320px;padding:6px" />
				<select id="roleFilter" style="margin-left:8px;padding:6px"><option value="">All Roles</option><option value="Staff">Staff</option><option value="Manager">Manager</option><option value="Admin">Admin</option></select>
				<button id="filterUsers" class="btn">Filter</button>
				<button id="createStaffBtn" class="btn btn-primary" style="margin-left:8px">Create Staff</button>
			</div>
		</div>
		<div id="usersContainer" style="display:none">
			<!-- User list will be rendered here -->
		</div>
	</div>

	<!-- User modal -->
	<div id="userModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:10000">
		<div style="background:#fff;padding:14px;border-radius:8px;max-width:640px;width:95%">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
				<strong id="userModalTitle">Create Staff</strong>
				<button id="closeUserModal" class="btn">Close</button>
			</div>
			<div style="margin-bottom:8px"><label>Full name</label><br/><input id="uFullName" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Email</label><br/><input id="uEmail" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Phone</label><br/><input id="uPhone" style="width:100%;padding:6px"/></div>
			<div style="margin-bottom:8px"><label>Role</label><br/>
				<select id="uRole" style="width:100%;padding:6px"><option value="Staff">Staff</option><option value="Manager">Manager</option><option value="Admin">Admin</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Station (required for Staff)</label><br/>
				<select id="uStationId" style="width:100%;padding:6px"><option value="">-- Select station --</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Status</label><br/>
				<select id="uStatus" style="width:100%;padding:6px"><option value="Active">Active</option><option value="Blocked">Blocked</option><option value="">(none)</option></select>
			</div>
			<div style="margin-bottom:8px"><label>Avatar URL</label><br/>
				<div style="border:1px solid #eee;padding:8px;border-radius:6px">
					<label><input type="radio" name="avatarMode" value="url" checked /> Nh·∫≠p URL t·ª´ Internet</label>
					<div style="margin-top:6px"><input id="uAvatar" style="width:100%;padding:6px" placeholder="https://... or leave empty" /></div>
					<div style="margin-top:8px"><label><input type="radio" name="avatarMode" value="upload" /> Upload ·∫£nh t·ª´ m√°y</label>
					<div style="margin-top:6px"><input id="uAvatarFile" type="file" accept="image/*" /></div>
					</div>
					<div style="margin-top:6px"><img id="uAvatarPreview" src="" style="width:80px;height:80px;border-radius:8px;display:inline-block"/></div>
				</div>
			</div>
			<div style="margin-bottom:8px;display:none"><label>Password (leave blank to keep)</label><br/><input id="uPassword" type="password" style="width:100%;padding:6px"/></div>
			<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
				<button id="saveUserBtn" class="btn btn-primary">Save</button>
				<button id="resetPasswordBtn" class="btn" style="display:none">Reset Password</button>
				<button id="deleteUserBtn" class="btn btn-danger" style="display:none">Delete</button>
			</div>
		</div>
	</div>

	<!-- AI D·ª± b√°o n√¢ng c·∫•p h·∫° t·∫ßng panel -->
	<div class="panel" style="margin-top:20px">
		<h2 style="margin-top:0">AI D·ª± b√°o n√¢ng c·∫•p h·∫° t·∫ßng</h2>
		<div style="margin-bottom:8px;color:#333">B·∫£ng c·∫£nh b√°o v√† ƒë·ªÅ xu·∫•t n√¢ng c·∫•p ƒë∆∞·ª£c ph√¢n t√≠ch t·ª´ d·ªØ li·ªáu h·ªá th·ªëng ‚Äî hi·ªÉn th·ªã tr·ª±c ti·∫øp. M·ªôt s·ªë th√¥ng tin nh·∫°y c·∫£m kh√¥ng ƒë∆∞·ª£c xu·∫•t kh·∫©u t·ª± ƒë·ªông.</div>
		<!-- Inline AI panel (progressive enhancement). If API isn't available the iframe fallback remains. -->
		<div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
			<div>
				<button id="toggleAIBtn" class="btn btn-primary" style="padding:8px 16px">
					ü§ñ T·∫£i b√°o c√°o d·ª± b√°o
				</button>
			</div>
			<div id="aiControls" style="display:none;flex:1;gap:8px;align-items:center">
				<input id="aiSearch" placeholder="T√¨m theo t√™n tr·∫°m..." style="padding:6px;border:1px solid #ddd;border-radius:4px;width:240px" />
				<select id="aiStatusFilter" style="padding:6px;border:1px solid #ddd;border-radius:4px">
					<option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
					<option value="ok">OK</option>
					<option value="warning">Warning</option>
					<option value="critical">Critical</option>
				</select>
				<button id="aiRefresh" class="btn">Refresh</button>
				<button id="exportCsvBtn" class="btn">üìä Export CSV</button>
			</div>
		</div>

		<!-- Data quality disclaimer (always visible) -->
		<div style="background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:6px;color:#1565c0;margin-bottom:10px;font-size:13px">
			<strong>‚ö†Ô∏è L∆ØU √ù:</strong> Dashboard n√†y ch·ªâ mang t√≠nh ch·∫•t <strong>tham kh·∫£o</strong> ƒë·ªÉ h·ªó tr·ª£ quy·∫øt ƒë·ªãnh. 
			Lu√¥n c√¢n nh·∫Øc th√™m khi s·ªë li·ªáu swap qu√° √≠t ho·∫∑c khi tr·∫°m m·ªõi ƒëi v√†o ho·∫°t ƒë·ªông. 
			<span style="font-size:11px;opacity:0.85">(Y√™u c·∫ßu t·ªëi thi·ªÉu: ‚â•3 giao d·ªãch trong 14 ng√†y, c√≥ d·ªØ li·ªáu slot capacity)</span>
		</div>

		<div id="aiWarning" style="display:none;background:#fff3cd;border:1px solid #ffeeba;padding:8px;border-radius:6px;color:#856404;margin-bottom:8px">C·∫£nh b√°o: d·ªØ li·ªáu l·ªãch s·ª≠ swap kh√¥ng ƒë·ªß ƒë·ªÉ d·ª± b√°o ch√≠nh x√°c ‚Äî xem chi ti·∫øt.</div>

		<div id="aiInlinePanel" style="width:100%;background:#fff;border-radius:6px;overflow:hidden;padding:8px;box-sizing:border-box;display:none">
			<!-- Table will be rendered here by JS when /admin/api/upgrade_suggestions is available -->
			<div id="aiTableContainer">
				<!-- AI data will be rendered here -->
			</div>
			<!-- Fallback iframe hidden by default - only show if inline fails -->
			<div id="aiFallbackFrame" style="display:none;margin-top:12px">
				<iframe id="aiInsightsFrame" src="./upgrade_insights.jsp" style="width:100%;height:220px;border:0;border-radius:6px"></iframe>
			</div>
		</div>

		<!-- Details modal (chart + extended recommendation) -->
		<div id="aiDetailsModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10001">
			<div style="background:#fff;padding:12px;border-radius:8px;max-width:900px;width:95%;max-height:90%;overflow:auto">
				<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
					<strong id="aiDetailsTitle">Chi ti·∫øt ƒë·ªÅ xu·∫•t</strong>
					<button id="aiCloseDetails" class="btn">ƒê√≥ng</button>
				</div>
				<div id="aiDetailsBody">
					<!-- Chart container with fixed max height -->
					<div style="position:relative;width:100%;max-height:300px;height:300px;margin-bottom:12px">
						<canvas id="aiTrendChart" style="width:100%;height:100%;background:#fff;border:1px solid #f0f0f0;border-radius:6px"></canvas>
					</div>
					<!-- Summary stats and recommendation -->
					<div id="aiDetailsRecommendation" style="margin-top:12px"></div>
					<!-- Detailed explanation section -->
					<div id="aiDetailsExplanation" style="margin-top:12px;padding:10px;background:#f9f9f9;border-radius:6px;font-size:13px;color:#333"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
	// Base paths ‚Äî compute dynamically from current path so admin UI works under different servlet contexts
	// e.g. if served at http://host/<context>/admin then BASE will be http://host/<context>
	const _ctxSegment = (window.location.pathname || '').split('/')[1] || '';
	const _defaultBase = _ctxSegment ? window.location.origin + '/' + _ctxSegment : window.location.origin;
	const BASE = (window.ADMIN_DASHBOARD_URL_BASE && typeof window.ADMIN_DASHBOARD_URL_BASE === 'string') ? window.ADMIN_DASHBOARD_URL_BASE.replace(/\/$/, '') : _defaultBase.replace(/\/$/, '');
		const API_STATIONS_GET = BASE + '/admin/api/stations_with_charging.jsp'; // returns stations with nested ChargingStations
		const API_STATIONS_CRUD = BASE + '/api/admin/station'; // admin servlet handles create/update/delete (requires session)
		const API_CS = BASE + '/admin/api/charging_stations'; // servlet for charging station CRUD (GET/POST/DELETE)
		// AI insights page (server-side JSP powered by StationUpgradeSuggestionController)
		const AI_PAGE = BASE + '/admin/upgrade_insights.jsp';
		// set iframe src if present (embed AI panel into dashboard)
		setTimeout(()=>{
			const f = document.getElementById('aiInsightsFrame');
			if (f) f.src = AI_PAGE;
		}, 50);

		// ----- Inline AI rendering (fetch JSON from servlet if available) -----
		window._aiData = []; // Store globally for details/export
		async function fetchUpgradeInsights(){
			const container = document.getElementById('aiTableContainer');
			if (!container) return;
			
			// Show loading spinner
			container.innerHTML = '<div style="text-align:center;padding:40px 20px"><div style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite"></div><p class="muted" style="margin-top:12px">ƒêang t·∫£i d·ªØ li·ªáu ph√¢n t√≠ch...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>';
			
			try {
				const res = await fetch(BASE + '/admin/api/upgrade_suggestions', { credentials: 'include' });
				if (!res.ok) throw new Error('HTTP ' + res.status);
				const data = await res.json();
				window._aiData = data || []; // Store for later use
				renderInsightsTable(data || []);
				// Hide fallback iframe on success
				const fallback = document.getElementById('aiFallbackFrame');
				if (fallback) fallback.style.display = 'none';
			} catch(err){
				container.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu AI qua API: '+String(err)+'<br/>Xem b·∫£ng d∆∞·ªõi ƒë√¢y (server-side render).</div>';
				// Show fallback iframe if API fails
				const fallback = document.getElementById('aiFallbackFrame');
				if (fallback) fallback.style.display = '';
				throw err; // Re-throw to trigger catch in button handler
			}
		}

		function computeBadge(item){
			// STRICT PRECEDENCE RULES: Must match backend StationUpgradeSuggestionController.java exactly
			try {
				// First check if backend explicitly provided status field
				if (item.status) {
					switch(item.status) {
						case 'WARNING_DATA': return { cls: 'warning-data', label: '‚ö†Ô∏è DATA' };
						case 'CRITICAL': return { cls: 'critical', label: 'üö® CRITICAL' };
						case 'WARNING': return { cls: 'warning', label: '‚ö†Ô∏è WARNING' };
						case 'OK': return { cls: 'ok', label: '‚úÖ OK' };
						default: return { cls: 'ok', label: 'OK' };
					}
				}
				
				// Fallback: compute locally using same rules as backend
				const sampleSize = Number(item.sampleSize || 0);
				const slotCap = Number(item.slotCapacity || 1);
				
				// RULE 1: Insufficient data (WARNING_DATA)
				if (sampleSize < 5) {
					return { cls: 'warning-data', label: '‚ö†Ô∏è DATA' };
				}
				
				// Parse metrics
				const failRate = parseFloat((item.failRate || '0%').toString().replace('%','')) || 0; // as percentage
				const overload = Number(item.overloadDays || 0);
				const last7Avg = Number(item.last7Avg || 0);
				const growth = parseFloat(item.growthPercent || 0) || 0;
				
				// RULE 2: CRITICAL - failRate >= 20% OR overload >= 2 OR last7Avg >= capacity
				if (failRate >= 20 || overload >= 2 || last7Avg >= slotCap) {
					return { cls: 'critical', label: 'üö® CRITICAL' };
				}
				
				// RULE 3: WARNING - failRate >= 10% OR overload == 1 OR last7Avg >= 80% capacity OR growth >= 50%
				if (failRate >= 10 || overload === 1 || last7Avg >= slotCap * 0.8 || growth >= 50) {
					return { cls: 'warning', label: '‚ö†Ô∏è WARNING' };
				}
				
				// RULE 4: OK - all metrics healthy
				return { cls: 'ok', label: '‚úÖ OK' };
			} catch(e){ 
				console.error('computeBadge error:', e);
				return { cls: 'ok', label: 'OK' }; 
			}
		}

		function renderInsightsTable(list){
			const container = document.getElementById('aiTableContainer');
			if (!container) return;
			if (!Array.isArray(list) || list.length === 0){ container.innerHTML = '<div class="muted">Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t</div>'; return; }
			
			// Add legend/tooltip definitions
			let html = '<div style="margin-bottom:12px;padding:8px;background:#f9f9f9;border-radius:6px;font-size:13px">';
			html += '<strong>Ch√∫ th√≠ch c√°c ch·ªâ s·ªë:</strong><br/>';
			html += '<span style="color:#666">‚Ä¢ <strong>last7Avg</strong>: Trung b√¨nh l∆∞·ª£t ƒë·ªïi pin/ng√†y trong 7 ng√†y g·∫ßn nh·∫•t</span><br/>';
			html += '<span style="color:#666">‚Ä¢ <strong>prev7Avg</strong>: Trung b√¨nh l∆∞·ª£t ƒë·ªïi pin/ng√†y c·ªßa 7 ng√†y tr∆∞·ªõc ƒë√≥</span><br/>';
			html += '<span style="color:#666">‚Ä¢ <strong>overloadDays</strong>: S·ªë ng√†y tr·∫°m b·ªã qu√° t·∫£i (booking > slot capacity)</span><br/>';
			html += '<span style="color:#666">‚Ä¢ <strong>failRate</strong>: T·ªâ l·ªá giao d·ªãch l·ªói ho·∫∑c ch∆∞a ho√†n th√†nh</span><br/>';
			html += '<span style="color:#666">‚Ä¢ <strong>Status</strong>: <span style="background:#9e9e9e;color:#fff;padding:2px 6px;border-radius:4px;font-size:11px">‚ö†Ô∏è DATA</span> = Kh√¥ng ƒë·ªß d·ªØ li·ªáu | ';
			html += '<span style="background:#4caf50;color:#fff;padding:2px 6px;border-radius:4px;font-size:11px">‚úÖ OK</span> = B√¨nh th∆∞·ªùng | ';
			html += '<span style="background:#ff9800;color:#fff;padding:2px 6px;border-radius:4px;font-size:11px">‚ö†Ô∏è WARNING</span> = C·∫ßn theo d√µi | ';
			html += '<span style="background:#f44336;color:#fff;padding:2px 6px;border-radius:4px;font-size:11px">üö® CRITICAL</span> = C·∫ßn n√¢ng c·∫•p ngay</span>';
			html += '</div>';
			
			// build table with station name column
			html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
			html += '<th style="text-align:left">ID</th>';
			html += '<th style="text-align:left">T√™n Tr·∫°m</th>';
			html += '<th style="text-align:center" title="Trung b√¨nh l∆∞·ª£t ƒë·ªïi/ng√†y (7 ng√†y g·∫ßn nh·∫•t)">last7Avg</th>';
			html += '<th style="text-align:center" title="Trung b√¨nh l∆∞·ª£t ƒë·ªïi/ng√†y (7 ng√†y tr∆∞·ªõc ƒë√≥)">prev7Avg</th>';
			html += '<th style="text-align:center" title="S·ªë ng√†y qu√° t·∫£i">overloadDays</th>';
			html += '<th style="text-align:center" title="T·ªâ l·ªá giao d·ªãch l·ªói">failRate</th>';
			html += '<th style="text-align:left">ƒê·ªÅ xu·∫•t</th>';
			html += '<th style="text-align:center">Status</th>';
			html += '<th style="text-align:center">Actions</th>';
			html += '</tr></thead><tbody>';
			
			list.forEach(item=>{
				const badge = computeBadge(item);
				const stationId = item.stationId || item.Station_ID || '';
				const stationName = item.stationName || item.StationName || ('Tr·∫°m #' + stationId);
				// Badge color mapping for 4 status levels
				let badgeColor = '#4caf50'; // Default OK (green)
				if (badge.cls === 'warning-data') badgeColor = '#9e9e9e'; // Gray for insufficient data
				else if (badge.cls === 'critical') badgeColor = '#f44336'; // Red
				else if (badge.cls === 'warning') badgeColor = '#ff9800'; // Orange
				
				// ====================================================================
				// Check if data is insufficient for detailed analysis (Rule 1)
				// ====================================================================
				const sampleSize = item.sampleSize || 0;
				const slotCapacity = item.slotCapacity || 0;
				const dataInsufficient = item.dataInsufficient || false;
				const slotCapacityMissing = item.slotCapacityMissing || false;
				
				// Rule 1: sampleSize < 5 OR slotCapacity <= 0 ‚Üí insufficient data
				const isInsufficientData = (sampleSize < 5) || (slotCapacity <= 0) || dataInsufficient || slotCapacityMissing;
				
				// Details button: disable if insufficient data
				let detailsButton = '';
				if (isInsufficientData) {
					detailsButton = `<button class="btn" disabled style="background:#ccc;cursor:not-allowed;opacity:0.5" title="‚ö†Ô∏è Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch chi ti·∫øt">Details</button>`;
				} else {
					detailsButton = `<button class="btn" data-action="details">Details</button>`;
				}
				
				html += `<tr data-id="${stationId}">`;
				html += `<td>${stationId}</td>`;
				html += `<td><strong>${escapeHtml(stationName)}</strong></td>`;
				html += `<td style="text-align:center">${Number(item.last7Avg||0).toFixed(1)}</td>`;
				html += `<td style="text-align:center">${Number(item.prev7Avg||0).toFixed(1)}</td>`;
				html += `<td style="text-align:center">${item.overloadDays||0}</td>`;
				html += `<td style="text-align:center">${item.failRate||'0%'}</td>`;
				html += `<td style="max-width:300px">${escapeHtml(item.recommendation||item.suggestion||'Kh√¥ng c·∫ßn n√¢ng c·∫•p ngay')}</td>`;
				html += `<td style="text-align:center"><span class="ai-badge ${badge.cls}" style="background:${badgeColor};padding:4px 10px;border-radius:12px;color:#fff;font-size:12px;font-weight:600">${badge.label}</span></td>`;
				html += `<td style="text-align:center">${detailsButton}</td>`;
				html += `</tr>`;
			});
			html += '</tbody></table>';
			container.innerHTML = html;
			// attach details handlers
			document.querySelectorAll('#aiTableContainer button[data-action="details"]').forEach(b=> b.addEventListener('click', async (e)=>{
				const tr = e.target.closest('tr'); const id = tr && tr.dataset && tr.dataset.id; if (!id) return;
				openDetailsModal(id);
			}));
			// show warning if many items have small sample sizes (simple heuristic)
			const lowDataCount = list.filter(i => (i.sampleSize||0) < 7).length;
			const warnEl = document.getElementById('aiWarning');
			if (warnEl) warnEl.style.display = (lowDataCount > 0 ? '' : 'none');
		}

		// Export CSV with proper headers and formatting
		function downloadCSV(rows, filename){
			if (!Array.isArray(rows) || rows.length === 0) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export'); return; }
			
			// Sort by status priority: Critical > Warning > OK > WARNING_DATA (insufficient data at bottom)
			const sortedRows = [...rows].sort((a, b) => {
				const badgeA = computeBadge(a);
				const badgeB = computeBadge(b);
				const priority = { 'critical': 4, 'warning': 3, 'ok': 2, 'warning-data': 1 };
				return (priority[badgeB.cls] || 0) - (priority[badgeA.cls] || 0);
			});
			
			// Count by status for summary
			const statusCounts = { critical: 0, warning: 0, ok: 0 };
			sortedRows.forEach(r => {
				const badge = computeBadge(r);
				if (badge.cls === 'critical') statusCounts.critical++;
				else if (badge.cls === 'warning') statusCounts.warning++;
				else statusCounts.ok++;
			});
			
			// Build CSV with annotation header
			let csv = '# =============================================================\n';
			csv += '# B√ÅO C√ÅO D·ª∞ B√ÅO N√ÇNG C·∫§P H·∫† T·∫¶NG TR·∫†M ƒê·ªîI PIN - AI INSIGHTS\n';
			csv += '# =============================================================\n';
			csv += '# Ng√†y xu·∫•t: ' + new Date().toLocaleString('vi-VN', { dateStyle: 'full', timeStyle: 'medium' }) + '\n';
			csv += '# Ng∆∞·ªùi xu·∫•t: Admin Dashboard\n';
			csv += '# T·ªïng s·ªë tr·∫°m trong b√°o c√°o: ' + sortedRows.length + '\n';
			csv += '#   ‚Ä¢ Critical (Kh·∫©n c·∫•p): ' + statusCounts.critical + ' tr·∫°m\n';
			csv += '#   ‚Ä¢ Warning (C·∫£nh b√°o): ' + statusCounts.warning + ' tr·∫°m\n';
			csv += '#   ‚Ä¢ OK (An to√†n): ' + statusCounts.ok + ' tr·∫°m\n';
			csv += '#\n';
			csv += '# CH√ö TH√çCH C√ÅC C·ªòT:\n';
			csv += '# - Station_ID: M√£ s·ªë tr·∫°m trong h·ªá th·ªëng\n';
			csv += '# - Station_Name: T√™n ƒë·∫ßy ƒë·ªß c·ªßa tr·∫°m ƒë·ªïi pin\n';
			csv += '# - Address: ƒê·ªãa ch·ªâ tr·∫°m (n·∫øu c√≥)\n';
			csv += '# - Last_7_Days_Avg: Trung b√¨nh s·ªë l∆∞·ª£t ƒë·ªïi pin/ng√†y (7 ng√†y g·∫ßn nh·∫•t)\n';
			csv += '# - Previous_7_Days_Avg: Trung b√¨nh s·ªë l∆∞·ª£t ƒë·ªïi pin/ng√†y (7 ng√†y tr∆∞·ªõc ƒë√≥)\n';
			csv += '# - Growth_Percent: T·ª∑ l·ªá tƒÉng tr∆∞·ªüng (%) so v·ªõi tu·∫ßn tr∆∞·ªõc\n';
			csv += '# - Capacity_Utilization: T·ª∑ l·ªá s·ª≠ d·ª•ng c√¥ng su·∫•t (%) = Last7Avg / SlotCapacity * 100\n';
			csv += '# - Overload_Days: S·ªë ng√†y b·ªã qu√° t·∫£i (s·ªë booking > slot capacity) trong 14 ng√†y g·∫ßn nh·∫•t\n';
			csv += '# - Fail_Rate: T·ª∑ l·ªá giao d·ªãch l·ªói ho·∫∑c ch∆∞a ho√†n th√†nh (%), t√≠nh trong 7 ng√†y g·∫ßn nh·∫•t\n';
			csv += '# - Slot_Capacity: T·ªïng s·ªë slot (khe ƒë·ªïi pin) hi·ªán c√≥ t·∫°i tr·∫°m\n';
			csv += '# - Total_Transactions: T·ªïng s·ªë giao d·ªãch ho√†n th√†nh trong 14 ng√†y\n';
			csv += '# - Status: M·ª©c ƒë·ªô kh·∫©n c·∫•p (OK = An to√†n | Warning = C·∫ßn theo d√µi | Critical = Kh·∫©n c·∫•p)\n';
			csv += '# - Recommendation: ƒê·ªÅ xu·∫•t h√†nh ƒë·ªông c·ª• th·ªÉ t·ª´ AI\n';
			csv += '#\n';
			csv += '# L∆ØU √ù:\n';
			csv += '# - D·ªØ li·ªáu d·ª±a tr√™n swap logs 14 ng√†y g·∫ßn nh·∫•t\n';
			csv += '# - Tr·∫°m n√†o c√≥ < 7 giao d·ªãch trong 14 ng√†y ƒë∆∞·ª£c coi l√† thi·∫øu d·ªØ li·ªáu\n';
			csv += '# - Khuy·∫øn ngh·ªã n√¢ng c·∫•p ∆∞u ti√™n tr·∫°m Critical tr∆∞·ªõc, sau ƒë√≥ ƒë·∫øn Warning\n';
			csv += '# - ƒê·ªãnh d·∫°ng: UTF-8 with BOM (m·ªü b·∫±ng Excel ho·∫∑c LibreOffice Calc)\n';
			csv += '# =============================================================\n';
			csv += '\n';
			
			// Header row
			const headers = ['Station_ID', 'Station_Name', 'Address', 'Last_7_Days_Avg', 'Previous_7_Days_Avg', 'Growth_Percent', 'Capacity_Utilization_%', 'Overload_Days', 'Fail_Rate', 'Slot_Capacity', 'Total_Transactions', 'Status', 'Recommendation'];
			csv += headers.join(',') + '\n';
			
			// Data rows (sorted by status priority)
			sortedRows.forEach(r => {
				const badge = computeBadge(r);
				const last7 = Number(r.last7Avg || 0);
				const prev7 = Number(r.prev7Avg || 0);
				const growth = prev7 > 0 ? ((last7 - prev7) / prev7 * 100).toFixed(1) : '0.0';
				const slotCap = Number(r.slotCapacity || 1);
				const capacityUtil = ((last7 / slotCap) * 100).toFixed(1);
				
				const row = [
					r.stationId || r.Station_ID || 'N/A',
					(r.stationName || r.StationName || ('Tr·∫°m #' + (r.stationId || r.Station_ID))).replace(/"/g, '""'),
					(r.address || r.Address || 'Kh√¥ng r√µ ƒë·ªãa ch·ªâ').replace(/"/g, '""'),
					last7.toFixed(1),
					prev7.toFixed(1),
					growth + '%',
					capacityUtil + '%',
					r.overloadDays || 0,
					r.failRate || '0%',
					r.slotCapacity || 0,
					r.sampleSize || r.totalTransactions || 0,
					badge.label,
					(r.recommendation || r.suggestion || 'Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t').replace(/"/g, '""')
				];
				csv += row.map(v => '"' + String(v) + '"').join(',') + '\n';
			});
			
			// Footer
			csv += '\n';
			csv += '# =============================================================\n';
			csv += '# END OF REPORT\n';
			csv += '# Generated by EV Battery Swap AI Infrastructure System\n';
			csv += '# Copyright ¬© 2024-2025 | For internal use only\n';
			csv += '# =============================================================\n';
			
			const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }); // BOM for Excel UTF-8
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a'); 
			a.href = url; 
			a.download = filename || ('AI_Infrastructure_Report_' + new Date().toISOString().split('T')[0] + '.csv'); 
			document.body.appendChild(a); 
			a.click(); 
			a.remove(); 
			URL.revokeObjectURL(url);
			alert('‚úÖ Export CSV th√†nh c√¥ng!\n\nüìä B√°o c√°o bao g·ªìm:\n‚Ä¢ Critical: ' + statusCounts.critical + ' tr·∫°m\n‚Ä¢ Warning: ' + statusCounts.warning + ' tr·∫°m\n‚Ä¢ OK: ' + statusCounts.ok + ' tr·∫°m');
		}

		// ====================================================================
		// PDF Export Feature REMOVED
		// Only CSV export is supported for AI Infrastructure Report
		// ====================================================================

		// details modal + chart (uses Chart.js if available)
		let currentChart = null;
		async function openDetailsModal(stationId){
			// FIX: Use cached data from window._aiData to get station-specific info (not re-fetch all stations)
			const info = (window._aiData || []).find(x=> String(x.stationId||x.Station_ID) === String(stationId));
			if (!info) {
				alert('‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho tr·∫°m #' + stationId + '. Vui l√≤ng refresh!');
				return;
			}
			
			document.getElementById('aiDetailsTitle').innerText = 'Chi ti·∫øt ƒë·ªÅ xu·∫•t ‚Äî ' + (info.stationName ? info.stationName : ('Tr·∫°m #' + stationId));
			document.getElementById('aiDetailsRecommendation').innerHTML = 'ƒêang x·ª≠ l√Ω...';
			document.getElementById('aiDetailsExplanation').innerHTML = '';
			document.getElementById('aiDetailsModal').style.display = 'flex';
			
			try {
				// Use cached station info directly (no need to re-fetch)
				
				// Build summary stats section (always show even without chart)
				let summaryHtml = '<div style="background:#e3f2fd;padding:12px;border-radius:6px;margin-bottom:12px;border-left:4px solid #1976d2"><strong>üìä S·ªë li·ªáu t√≥m t·∫Øt:</strong><br/>';
				summaryHtml += '‚Ä¢ <strong>Trung b√¨nh 7 ng√†y g·∫ßn nh·∫•t</strong>: ' + (info.last7Avg != null ? Number(info.last7Avg).toFixed(1) : 'N/A') + ' l∆∞·ª£t/ng√†y<br/>';
				summaryHtml += '‚Ä¢ <strong>Trung b√¨nh 7 ng√†y tr∆∞·ªõc ƒë√≥</strong>: ' + (info.prev7Avg != null ? Number(info.prev7Avg).toFixed(1) : 'N/A') + ' l∆∞·ª£t/ng√†y<br/>';
				summaryHtml += '‚Ä¢ <strong>S·ªë ng√†y qu√° t·∫£i</strong>: ' + (info.overloadDays != null ? info.overloadDays : 'N/A') + ' ng√†y (trong 14 ng√†y)<br/>';
				summaryHtml += '‚Ä¢ <strong>T·ªâ l·ªá l·ªói</strong>: ' + (info.failRate || '0%') + '<br/>';
				summaryHtml += '‚Ä¢ <strong>T·ªïng giao d·ªãch</strong>: ' + (info.sampleSize || info.totalTransactions || 'N/A') + ' l∆∞·ª£t<br/>';
				summaryHtml += '‚Ä¢ <strong>Slot capacity</strong>: ' + (info.slotCapacity || 'N/A') + ' slots</div>';
				
				// populate recommendation text with summary
				document.getElementById('aiDetailsRecommendation').innerHTML = summaryHtml + '<div style="padding:10px;background:#fff3cd;border-left:4px solid #ff9800;border-radius:4px"><strong>üí° ƒê·ªÅ xu·∫•t:</strong><br/>' + escapeHtml(info.recommendation || info.suggestion || info.message || 'Kh√¥ng c√≥ chi ti·∫øt') + '</div>';
				
				// Build detailed explanation
				let explainHtml = '<strong>üìñ Gi·∫£i th√≠ch chi ti·∫øt:</strong><br/>';
				const last7 = Number(info.last7Avg || 0).toFixed(1);
				const prev7 = Number(info.prev7Avg || 0).toFixed(1);
				const growth = prev7 > 0 ? (((last7 - prev7) / prev7) * 100).toFixed(1) : 'N/A';
				explainHtml += `‚Ä¢ Tr·∫°m n√†y x·ª≠ l√Ω trung b√¨nh <strong>${last7} l∆∞·ª£t ƒë·ªïi pin/ng√†y</strong> trong 7 ng√†y g·∫ßn nh·∫•t, so v·ªõi <strong>${prev7} l∆∞·ª£t/ng√†y</strong> trong 7 ng√†y tr∆∞·ªõc ƒë√≥.<br/>`;
				if (growth !== 'N/A') {
					if (growth > 0) explainHtml += `‚Ä¢ Xu h∆∞·ªõng: <span style="color:#4caf50;font-weight:600">‚Üó TƒÉng ${growth}%</span> ‚Äî nhu c·∫ßu ƒëang tƒÉng.<br/>`;
					else if (growth < 0) explainHtml += `‚Ä¢ Xu h∆∞·ªõng: <span style="color:#f44336;font-weight:600">‚Üò Gi·∫£m ${Math.abs(growth)}%</span> ‚Äî nhu c·∫ßu gi·∫£m.<br/>`;
					else explainHtml += `‚Ä¢ Xu h∆∞·ªõng: <span style="color:#999;font-weight:600">‚Üí ·ªîn ƒë·ªãnh</span>.<br/>`;
				}
				const overload = info.overloadDays || 0;
				if (overload > 0) explainHtml += `‚Ä¢ Trong 14 ng√†y g·∫ßn nh·∫•t, c√≥ <strong>${overload} ng√†y</strong> l∆∞·ª£ng booking v∆∞·ª£t qu√° slot capacity ‚Üí nguy c∆° qu√° t·∫£i.<br/>`;
				else explainHtml += `‚Ä¢ Kh√¥ng c√≥ ng√†y n√†o qu√° t·∫£i trong 14 ng√†y g·∫ßn nh·∫•t ‚Üí nƒÉng l·ª±c ƒë√°p ·ª©ng t·ªët.<br/>`;
				const failRate = info.failRate || '0%';
				explainHtml += `‚Ä¢ T·ªâ l·ªá l·ªói/ch∆∞a ho√†n th√†nh: <strong>${failRate}</strong>`;
				if (parseFloat(failRate) > 10) explainHtml += ` ‚Äî <span style="color:#f44336">cao, c·∫ßn ki·ªÉm tra thi·∫øt b·ªã</span>.`;
				else explainHtml += ` ‚Äî <span style="color:#4caf50">trong ng∆∞·ª°ng ch·∫•p nh·∫≠n</span>.`;
				explainHtml += '<br/>';
				const sample = info.sampleSize || info.totalTransactions || 0;
				if (sample < 7) explainHtml += `‚ö†Ô∏è <strong>C·∫£nh b√°o</strong>: Ch·ªâ c√≥ ${sample} giao d·ªãch trong 14 ng√†y ‚Äî d·ªØ li·ªáu qu√° √≠t ƒë·ªÉ d·ª± b√°o ch√≠nh x√°c. Thu th·∫≠p th√™m swap logs!<br/>`;
				document.getElementById('aiDetailsExplanation').innerHTML = explainHtml;
				
				// draw chart or show friendly message
				const ctx = document.getElementById('aiTrendChart');
				if (!ctx) return;
				
				const hasDailyCounts = info.dailyCounts && Array.isArray(info.dailyCounts) && info.dailyCounts.length > 0;
				
				if (!hasDailyCounts) {
					// No data - show friendly message in canvas
					if (currentChart) { currentChart.destroy(); currentChart = null; }
					const c2d = ctx.getContext('2d');
					c2d.clearRect(0, 0, ctx.width, ctx.height);
					c2d.fillStyle = '#666';
					c2d.font = '14px Arial';
					c2d.textAlign = 'center';
					c2d.fillText('‚ùå Kh√¥ng c√≥ l·ªãch s·ª≠ giao d·ªãch swap cho tr·∫°m n√†y', ctx.width/2, ctx.height/2 - 20);
					c2d.font = '12px Arial';
					c2d.fillStyle = '#999';
					c2d.fillText('H√£y thu th·∫≠p th√™m d·ªØ li·ªáu swap logs ƒë·ªÉ d·ª± b√°o ch√≠nh x√°c!', ctx.width/2, ctx.height/2 + 10);
					return;
				}
				
				const labels = info.dailyCounts.map(x=> x.day || x.date || '');
				const values = info.dailyCounts.map(x=> Number(x.count || x.swaps || 0));
				
				if (values.length === 1) {
					// Only one data point - show as static value instead of chart
					if (currentChart) { currentChart.destroy(); currentChart = null; }
					const c2d = ctx.getContext('2d');
					c2d.clearRect(0, 0, ctx.width, ctx.height);
					c2d.fillStyle = '#333';
					c2d.font = '16px Arial';
					c2d.textAlign = 'center';
					c2d.fillText('Ch·ªâ c√≥ 1 ng√†y d·ªØ li·ªáu: ' + values[0] + ' swaps v√†o ' + labels[0], ctx.width/2, ctx.height/2);
					return;
				}
				
				// Render chart with Chart.js
				if (window.Chart){
					if (currentChart) currentChart.destroy();
					currentChart = new Chart(ctx.getContext('2d'), { 
						type: 'line', 
						data: { 
							labels: labels, 
							datasets: [{ 
								label: 'Swaps/day', 
								data: values, 
								borderColor: '#1976d2', 
								backgroundColor: 'rgba(25,118,210,0.1)', 
								fill: true,
								tension: 0.3
							}] 
						}, 
						options: { 
							responsive: true, 
							maintainAspectRatio: false,
							plugins: {
								title: { display: true, text: 'Xu h∆∞·ªõng swap 14 ng√†y g·∫ßn nh·∫•t' }
							},
							scales: {
								y: { beginAtZero: true }
							}
						} 
					});
				} else {
					// Chart.js not loaded yet - show text
					const c2d = ctx.getContext('2d');
					c2d.clearRect(0, 0, ctx.width, ctx.height);
					c2d.fillStyle = '#666';
					c2d.font = '12px Arial';
					c2d.fillText('Chart.js ƒëang t·∫£i... D·ªØ li·ªáu: ' + JSON.stringify(values.slice(0,5)), 10, 30);
				}
			} catch(err){ 
				document.getElementById('aiDetailsRecommendation').innerHTML = '<div style="color:#c62828">L·ªói t·∫£i chi ti·∫øt: ' + String(err) + '</div>'; 
				// Clear chart on error
				const ctx = document.getElementById('aiTrendChart');
				if (ctx && currentChart) { currentChart.destroy(); currentChart = null; }
			}
		}

		// wire controls
		document.getElementById('aiRefresh').addEventListener('click', ()=> { 
			// Clear search box and reset status filter
			const searchBox = document.getElementById('aiSearch');
			const statusFilter = document.getElementById('aiStatusFilter');
			if (searchBox) searchBox.value = '';
			if (statusFilter) statusFilter.value = '';
			
			// Remove any "no results" message
			const noResultMsg = document.querySelector('.no-search-result');
			if (noResultMsg) noResultMsg.remove();
			
			// Fetch fresh data
			fetchUpgradeInsights();
		});
		document.getElementById('exportCsvBtn').addEventListener('click', async ()=>{
			try {
				// Export only VISIBLE (filtered) stations, not entire dataset
				const visibleRows = Array.from(document.querySelectorAll('#aiTableContainer tbody tr')).filter(tr => tr.style.display !== 'none');
				const visibleStationIds = visibleRows.map(tr => tr.dataset.id).filter(Boolean);
				
				if (visibleStationIds.length === 0) {
					alert('‚ö†Ô∏è Kh√¥ng c√≥ tr·∫°m n√†o ƒë·ªÉ export (t·∫•t c·∫£ ƒë√£ b·ªã filter). Vui l√≤ng reset filter ho·∫∑c search!');
					return;
				}
				
				// Filter cached data by visible station IDs
				const dataToExport = (window._aiData || []).filter(item => 
					visibleStationIds.includes(String(item.stationId || item.Station_ID))
				);
				
				if (dataToExport.length === 0) {
					alert('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export. Vui l√≤ng refresh!');
					return;
				}
				
				downloadCSV(dataToExport, 'ai_insights.csv');
			} catch(e){ 
				alert('‚ùå Export CSV th·∫•t b·∫°i: ' + e.message); 
				console.error('CSV export error:', e);
			}
		});
		
		// PDF Export button removed - only CSV export is supported
		
		document.getElementById('aiCloseDetails').addEventListener('click', ()=> { document.getElementById('aiDetailsModal').style.display = 'none'; if (currentChart) { currentChart.destroy(); currentChart = null; } });
		
		// SEARCH FILTER: Search by station name (case-insensitive), search both ID and Name columns
		document.getElementById('aiSearch').addEventListener('input', function(){
			const q = this.value.trim().toLowerCase();
			let visibleCount = 0;
			
			document.querySelectorAll('#aiTableContainer tbody tr').forEach(tr => {
				// Search in both ID column (children[0]) and Name column (children[1])
				const idText = (tr.children[0] && tr.children[0].innerText || '').toLowerCase();
				const nameText = (tr.children[1] && tr.children[1].innerText || '').toLowerCase();
				const match = !q || idText.indexOf(q) !== -1 || nameText.indexOf(q) !== -1;
				tr.style.display = match ? '' : 'none';
				if (match) visibleCount++;
			});
			
			// Show "No results found" message if no matches
			const container = document.getElementById('aiTableContainer');
			let noResultMsg = container.querySelector('.no-search-result');
			if (visibleCount === 0 && q) {
				if (!noResultMsg) {
					noResultMsg = document.createElement('div');
					noResultMsg.className = 'no-search-result';
					noResultMsg.style.cssText = 'padding:20px;text-align:center;color:#999;font-style:italic';
					noResultMsg.innerHTML = 'üîç Kh√¥ng t√¨m th·∫•y tr·∫°m ph√π h·ª£p v·ªõi t·ª´ kh√≥a "<strong>' + escapeHtml(q) + '</strong>"';
					container.appendChild(noResultMsg);
				}
			} else if (noResultMsg) {
				noResultMsg.remove();
			}
		});
		
		// STATUS FILTER: Combined with search filter
		document.getElementById('aiStatusFilter').addEventListener('change', function(){
			const statusValue = this.value;
			const searchQuery = (document.getElementById('aiSearch').value || '').trim().toLowerCase();
			let visibleCount = 0;
			
			document.querySelectorAll('#aiTableContainer tbody tr').forEach(tr => {
				// First check search query
				const idText = (tr.children[0] && tr.children[0].innerText || '').toLowerCase();
				const nameText = (tr.children[1] && tr.children[1].innerText || '').toLowerCase();
				const matchSearch = !searchQuery || idText.indexOf(searchQuery) !== -1 || nameText.indexOf(searchQuery) !== -1;
				
				// Then check status filter
				const badge = tr.querySelector('.ai-badge');
				const cls = badge ? (badge.className || '') : '';
				const matchStatus = !statusValue || cls.indexOf(statusValue) !== -1;
				
				// Show row only if BOTH search and status match
				const show = matchSearch && matchStatus;
				tr.style.display = show ? '' : 'none';
				if (show) visibleCount++;
			});
			
			// Update no-result message
			const container = document.getElementById('aiTableContainer');
			let noResultMsg = container.querySelector('.no-search-result');
			if (visibleCount === 0 && (searchQuery || statusValue)) {
				if (!noResultMsg) {
					noResultMsg = document.createElement('div');
					noResultMsg.className = 'no-search-result';
					noResultMsg.style.cssText = 'padding:20px;text-align:center;color:#999;font-style:italic';
					container.appendChild(noResultMsg);
				}
				let msg = 'üîç Kh√¥ng t√¨m th·∫•y tr·∫°m ph√π h·ª£p';
				if (searchQuery && statusValue) msg += ' v·ªõi t·ª´ kh√≥a "<strong>' + escapeHtml(searchQuery) + '</strong>" v√† tr·∫°ng th√°i "<strong>' + statusValue + '</strong>"';
				else if (searchQuery) msg += ' v·ªõi t·ª´ kh√≥a "<strong>' + escapeHtml(searchQuery) + '</strong>"';
				else if (statusValue) msg += ' v·ªõi tr·∫°ng th√°i "<strong>' + statusValue + '</strong>"';
				noResultMsg.innerHTML = msg;
			} else if (noResultMsg) {
				noResultMsg.remove();
			}
		});

		// try to load Chart.js dynamically if not present (small convenience loader)
		if (typeof window.Chart === 'undefined'){
			const s = document.createElement('script');
			s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
			s.crossOrigin = 'anonymous';
			s.onload = () => { console.info('Chart.js loaded'); };
			s.onerror = () => { console.warn('Chart.js failed to load'); };
			document.head.appendChild(s);
		}

		// jsPDF library loading removed - PDF export feature discontinued
		// Only CSV export is supported for AI Infrastructure Report

		// ========================================================================
		// LOAD/CLOSE LIST TOGGLE MANAGEMENT
		// ========================================================================
		let _stationsOpen = false;
		let _stationsLoaded = false;
		let _usersOpen = false;
		let _usersLoaded = false;
		let _aiOpen = false;
		let _aiLoaded = false;

		// Toggle Stations List
		document.getElementById('toggleStationsBtn').addEventListener('click', function() {
			const container = document.getElementById('stationsContainer');
			
			if (_stationsOpen) {
				// Close list
				container.style.display = 'none';
				this.innerHTML = 'üìã T·∫£i danh s√°ch tr·∫°m';
				_stationsOpen = false;
			} else {
				// Open list
				if (!_stationsLoaded) {
					// First time loading
					this.disabled = true;
					this.innerHTML = '‚è≥ ƒêang t·∫£i...';
					fetchStations().then(() => {
						_stationsLoaded = true;
						_stationsOpen = true;
						container.style.display = 'block';
						this.disabled = false;
						this.innerHTML = '‚úñÔ∏è ƒê√≥ng danh s√°ch';
					}).catch(() => {
						this.disabled = false;
						this.innerHTML = 'ÔøΩ T·∫£i danh s√°ch tr·∫°m';
					});
				} else {
					// Already loaded, just show
					container.style.display = 'block';
					this.innerHTML = '‚úñÔ∏è ƒê√≥ng danh s√°ch';
					_stationsOpen = true;
				}
			}
		});

		// Toggle Users List
		document.getElementById('toggleUsersBtn').addEventListener('click', function() {
			const container = document.getElementById('usersContainer');
			const controls = document.getElementById('userControls');
			
			if (_usersOpen) {
				// Close list
				container.style.display = 'none';
				controls.style.display = 'none';
				this.innerHTML = 'üë• T·∫£i danh s√°ch nh√¢n s·ª±';
				_usersOpen = false;
			} else {
				// Open list
				if (!_usersLoaded) {
					// First time loading
					this.disabled = true;
					this.innerHTML = '‚è≥ ƒêang t·∫£i...';
					fetchUsers().then(() => {
						_usersLoaded = true;
						_usersOpen = true;
						container.style.display = 'block';
						controls.style.display = 'flex';
						this.disabled = false;
						this.innerHTML = '‚úñÔ∏è ƒê√≥ng danh s√°ch';
					}).catch(() => {
						this.disabled = false;
						this.innerHTML = 'üë• T·∫£i danh s√°ch nh√¢n s·ª±';
					});
				} else {
					// Already loaded, just show
					container.style.display = 'block';
					controls.style.display = 'flex';
					this.innerHTML = '‚úñÔ∏è ƒê√≥ng danh s√°ch';
					_usersOpen = true;
				}
			}
		});

		// Toggle AI Report
		document.getElementById('toggleAIBtn').addEventListener('click', function() {
			const container = document.getElementById('aiInlinePanel');
			const controls = document.getElementById('aiControls');
			
			if (_aiOpen) {
				// Close list
				container.style.display = 'none';
				controls.style.display = 'none';
				this.innerHTML = 'ü§ñ T·∫£i b√°o c√°o d·ª± b√°o';
				_aiOpen = false;
			} else {
				// Open list
				if (!_aiLoaded) {
					// First time loading
					this.disabled = true;
					this.innerHTML = '‚è≥ ƒêang t·∫£i...';
					fetchUpgradeInsights().then(() => {
						_aiLoaded = true;
						_aiOpen = true;
						container.style.display = 'block';
						controls.style.display = 'flex';
						this.disabled = false;
						this.innerHTML = '‚úñÔ∏è ƒê√≥ng b√°o c√°o';
					}).catch(() => {
						this.disabled = false;
						this.innerHTML = 'ü§ñ T·∫£i b√°o c√°o d·ª± b√°o';
					});
				} else {
					// Already loaded, just show
					container.style.display = 'block';
					controls.style.display = 'flex';
					this.innerHTML = '‚úñÔ∏è ƒê√≥ng b√°o c√°o';
					_aiOpen = true;
				}
			}
		});

		// Refresh button now reloads data if list is open
		document.getElementById('refreshBtn').addEventListener('click', () => {
			if (_stationsOpen && _stationsLoaded) fetchStations();
		});

		// AI Refresh button reloads AI data if list is open
		document.getElementById('aiRefresh').addEventListener('click', () => {
			if (_aiOpen && _aiLoaded) fetchUpgradeInsights();
		});
		document.getElementById('createBtn').addEventListener('click', async () => {
			const name = document.getElementById('newName').value.trim();
			const address = document.getElementById('newAddress').value.trim();
			if (!name) { alert('Name required'); return; }
			setStatus('Creating...');
			try {
				const res = await fetch(API_STATIONS_CRUD, {
					method: 'POST',
					credentials: 'include',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ Station_ID: 0, Name: name, Address: address })
				});
				if (!res.ok) throw new Error('HTTP ' + res.status);
				setStatus('Created');
				document.getElementById('newName').value = '';
				document.getElementById('newAddress').value = '';
				fetchStations();
			} catch (err) { setStatus('Create failed: ' + err); }
		});

		function setStatus(msg){ document.getElementById('status').innerText = msg || ''; }

		async function fetchStations(){
			setStatus('Loading...');
			const container = document.getElementById('stationsContainer');
			container.innerHTML = '<div style="text-align:center;padding:40px 20px"><div style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite"></div><p class="muted" style="margin-top:12px">ƒêang t·∫£i danh s√°ch tr·∫°m...</p></div>';
			
			try {
				const r = await fetch(API_STATIONS_GET, { credentials: 'include' });
				if (!r.ok) throw new Error('HTTP ' + r.status);
				const stations = await r.json();
				window._stations = stations || [];
				renderStations(window._stations);
				setStatus('Loaded ' + (stations.length||0) + ' stations');
			} catch (err) {
				setStatus('Error: ' + err);
				document.getElementById('stationsContainer').innerHTML = '<div class="muted">Error loading stations: '+err+'</div>';
				throw err; // Re-throw to trigger catch in button handler
			}
		}

		// when role changes, show/hide station selector (station only for Staff)
		document.addEventListener('DOMContentLoaded', function() {
			const roleSel = document.getElementById('uRole');
			if (!roleSel) return;
			const stationRow = document.getElementById('uStationId') ? document.getElementById('uStationId').parentElement : null;
			roleSel.addEventListener('change', function() {
				try {
					const v = (roleSel.value||'').toString().toLowerCase();
					if (stationRow) stationRow.style.display = (v === 'staff') ? '' : 'none';
				} catch(e) {}
			});
		});

		function renderStations(stations){
			const cont = document.getElementById('stationsContainer');
			if (!Array.isArray(stations) || stations.length === 0) { cont.innerHTML = '<div class="muted">No stations found</div>'; return; }

			let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Address</th><th>Totals</th><th>Actions</th></tr></thead><tbody>';
			stations.forEach(s => {
				const id = s.Station_ID || s.StationId || s.id || s.ID;
				const name = s.Name || s.name || '';
				const addr = s.Address || s.address || '';
				const cs = Array.isArray(s.ChargingStations) ? s.ChargingStations : [];
				const totalSlots = cs.reduce((sum,c)=> sum + (c.Slot_Capacity||0), 0);
				const totalPower = cs.reduce((sum,c)=> sum + parseFloat((c.Power_Rating||'0').toString().replace(/[^0-9.]/g,'' ) || 0), 0);

				html += `<tr data-id="${id}">`;
				html += `<td>${id}</td>`;
				html += `<td><input class="edit-name" value="${escapeHtml(name)}" style="width:260px"/></td>`;
				html += `<td><input class="edit-address" value="${escapeHtml(addr)}" style="width:360px"/></td>`;
				// format totals: slots and total power with unit and labels
				const totalPowerStr = Number(totalPower).toFixed(1).replace(/\.0$/,'');
				html += `<td>T·ªïng: ${totalSlots} (Slot) / ${totalPowerStr} kW (T·ªïng C√¥ng Su·∫•t)</td>`;
				html += `<td><button class="btn btn" data-action="open-detail">Edit</button> <button class="btn btn-primary btn-save">Save</button> <button class="btn btn-danger btn-delete">Delete</button> <button class="btn" data-action="toggle-cs">CS</button></td>`;
				html += `</tr>`;

				// inline charging station rows
				html += `<tr class="cs-row" data-parent="${id}" style="display:none"><td colspan="5">`;
				html += `<div style="margin-bottom:8px"><strong>Charging Stations</strong></div>`;
				html += `<table><thead><tr><th>ID</th><th>Name</th><th>Slot Cap</th><th>Type</th><th>Power</th><th>Actions</th></tr></thead><tbody>`;
				cs.forEach(c=>{
					const cid = c.ChargingStation_ID || c.id;
					const curType = (c.Slot_Type||c.slot_type||'') || '';
					const curPower = (c.Power_Rating||c.power_rating||'') || '';
					html += `<tr data-cid="${cid}"><td>${cid}</td><td><input class="cs-name" value="${escapeHtml(c.Name||c.name||'')}"/></td><td><input class="cs-cap" type="number" value="${c.Slot_Capacity||0}" style="width:80px"/></td>`;
					// normalize current power value (strip non-numeric)
					const curPowerVal = (String(curPower).match(/\d+(?:\.\d+)?/) || [''])[0];
					html += `<td><select class="cs-type"><option value="">--</option><option value="Lithium-ion" ${curType==='Lithium-ion'?'selected':''}>Lithium-ion</option><option value="LFP" ${curType==='LFP'?'selected':''}>LFP</option></select></td>`;
					html += `<td><select class="cs-power" style="width:90px"><option value="">--</option><option value="5.0" ${curPowerVal==='5.0'?'selected':''}>5.0 kW</option><option value="3.5" ${curPowerVal==='3.5'?'selected':''}>3.5 kW</option></select></td>`;
					html += `<td><button class="btn btn-primary cs-save">Save</button> <button class="btn btn-danger cs-delete">Delete</button></td></tr>`;
				});
				// add new row
				html += `<tr class="cs-new-row"><td>new</td><td><input class="cs-new-name"/></td><td><input class="cs-new-cap" type="number" value="1" style="width:80px"/></td><td><select class="cs-new-type"><option value="">--</option><option value="Lithium-ion">Lithium-ion</option><option value="LFP">LFP</option></select></td><td><select class="cs-new-power" style="width:90px"><option value="">--</option><option value="5.0">5.0 kW</option><option value="3.5">3.5 kW</option></select></td><td><button class="btn btn-primary cs-create">Add</button></td></tr>`;
				html += `</tbody></table>`;
				html += `</td></tr>`;
			});
			html += '</tbody></table>';
			cont.innerHTML = html;

			attachHandlers();
		}

	// helper: try JSON API then fall back to older form-based servlet if JSON endpoint missing (404)
	async function postChargingStation(body){
	    // try JSON API
	    try {
	        let res = await fetch(API_CS, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
	        if (res.status !== 404) return res;
	        // fallback to form-based servlet(s)
	        const action = (body.action||'create').toLowerCase();
	        const form = new URLSearchParams();
	        form.append('action', action);
	        if (action === 'create'){
	            form.append('stationId', String(body.station_id || body.Station_ID || ''));
	            form.append('name', String(body.name || ''));
	            form.append('slotCapacity', String(body.slot_capacity || body.Slot_Capacity || 0));
	            form.append('slotType', String(body.slot_type || body.Slot_Type || ''));
	            form.append('powerRating', String(body.power_rating != null ? body.power_rating : (body.Power_Rating || 0)));
	            // try /admin/charging first, then /charging (some builds map differently)
	            let res2 = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            if (res2.status === 404) {
	                res2 = await fetch(BASE + '/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            }
	            return res2;
	        } else if (action === 'update'){
	            form.append('chargingStationId', String(body.id || body.ChargingStation_ID || 0));
	            form.append('stationId', String(body.station_id || body.Station_ID || 0));
	            form.append('name', String(body.name || ''));
	            form.append('slotCapacity', String(body.slot_capacity || body.Slot_Capacity || 0));
	            form.append('slotType', String(body.slot_type || body.Slot_Type || ''));
	            form.append('powerRating', String(body.power_rating != null ? body.power_rating : (body.Power_Rating || 0)));
	            let res2 = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            if (res2.status === 404) {
	                res2 = await fetch(BASE + '/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
	            }
	            return res2;
	        } else {
	            // unknown action ‚Äî return original response
	            return res;
	        }
	    } catch (err) {
	        // propagate error to caller
	        throw err;
	    }
	}

	function attachHandlers(){

		document.querySelectorAll('button[data-action="toggle-cs"]').forEach(b=> b.addEventListener('click', (e)=>{
				const tr = e.target.closest('tr'); const id = tr.dataset.id;
				const row = document.querySelector(`.cs-row[data-parent="${id}"]`);
				row.style.display = row.style.display === 'none' ? '' : 'none';
			}));

			document.querySelectorAll('.btn-save').forEach(btn => btn.addEventListener('click', async e=>{
				const row = e.target.closest('tr');
				const id = row.dataset.id; const name = row.querySelector('.edit-name').value.trim(); const addr = row.querySelector('.edit-address').value.trim();
				if (!name) { alert('Name required'); return; }
				try {
						const res = await fetch(API_STATIONS_CRUD, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ Station_ID: parseInt(id,10), Name: name, Address: addr }) });
					if (!res.ok) {
						let errText = 'HTTP ' + res.status;
						try { errText = await res.text(); } catch(e) { /* ignore */ }
						throw new Error(errText || ('HTTP '+res.status));
					}
					fetchStations();
				} catch (err) { alert('Update failed: '+err); }
			}));

			document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', async e=>{
				const row = e.target.closest('tr'); const id = row.dataset.id;
				if (!confirm('Delete station '+id+'?')) return;
				try {
					const res = await fetch(API_STATIONS_CRUD + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
					if (!res.ok) {
						let errText = 'HTTP ' + res.status;
						try { errText = await res.text(); } catch(e) { /* ignore */ }
						throw new Error(errText || ('HTTP '+res.status));
					}
					fetchStations();
				} catch (err) { alert('Delete failed: '+err); }
			}));

			// CS handlers
			document.querySelectorAll('.cs-save').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; const parent = tr.closest('.cs-row').dataset.parent;
				const name = tr.querySelector('.cs-name').value.trim(); const cap = parseInt(tr.querySelector('.cs-cap').value||0,10); const type = tr.querySelector('.cs-type').value.trim(); const power = tr.querySelector('.cs-power').value.trim();
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action: 'update', id: cid, station_id: parent, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) {
						// try to extract JSON error message from server for friendlier UI
						let msg = 'HTTP ' + res.status;
						try {
							const errBody = await res.json();
							if (errBody) {
								if (errBody.error) msg = errBody.error;
								else if (errBody.message) msg = errBody.message;
								else msg = JSON.stringify(errBody);
							}
						} catch(e) {
							try { const t = await res.text(); if (t) msg = t; } catch(e2) { /* ignore */ }
						}
						throw new Error(msg);
					}
					fetchStations();
				} catch (err) { alert('CS update failed: '+err); }
			}));

			document.querySelectorAll('.cs-delete').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid;
				if (!confirm('Delete CS '+cid+'?')) return;
				try {
					// try API DELETE first, fall back to form POST delete
					let res = await fetch(API_CS + '?id=' + encodeURIComponent(cid), { method: 'DELETE', credentials: 'include' });
					if (res.status === 404) {
						// fallback to older servlet that expects form params
						const form = new URLSearchParams(); form.append('action','delete'); form.append('id', cid);
						res = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
					}
					if (!res.ok) {
						// try to read JSON error body to show a friendly message
						let text = await res.text();
						try {
							const obj = JSON.parse(text);
							const errMsg = obj && (obj.error || obj.message) ? (obj.error || obj.message) : (obj.status || text || ('HTTP '+res.status));
							// include hint if present for debugging (non-sensitive)
							const hint = obj && obj.hint ? (' (hint: ' + JSON.stringify(obj.hint) + ')') : '';
							throw new Error(errMsg + hint);
						} catch(eparse) {
							throw new Error(text || ('HTTP '+res.status));
						}
					}
					fetchStations();
				} catch (err) { alert('CS delete failed: '+err); }
			}));

			document.querySelectorAll('.cs-create').forEach(btn => btn.addEventListener('click', async e=>{
				const tr = e.target.closest('table').querySelector('.cs-new-row');
				const parentRow = e.target.closest('.cs-row'); const stationId = parentRow.dataset.parent;
				const name = tr.querySelector('.cs-new-name').value.trim(); const cap = parseInt(tr.querySelector('.cs-new-cap').value||0,10); const type = tr.querySelector('.cs-new-type').value.trim(); const power = tr.querySelector('.cs-new-power').value.trim();
				if (!name) { alert('Name required'); return; }
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action:'create', station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations();
				} catch (err) { alert('CS create failed: '+err); }
			}));

			// synchronize type <-> power for inline rows and new rows
			document.querySelectorAll('tr[data-cid], tr.cs-new-row').forEach(row => {
				const typeSel = row.querySelector('.cs-type') || row.querySelector('.cs-new-type');
				const powerSel = row.querySelector('.cs-power') || row.querySelector('.cs-new-power');
				if (!typeSel || !powerSel) return;
				const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
				const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
				typeSel.addEventListener('change', ()=>{
					const p = mapTypeToPower(typeSel.value);
					if (p) powerSel.value = p;
				});
				powerSel.addEventListener('change', ()=>{
					const t = mapPowerToType(powerSel.value);
					if (t) typeSel.value = t;
				});
			});

			// open detail modal
			document.querySelectorAll('button[data-action="open-detail"]').forEach(b=> b.addEventListener('click', (e)=>{
				const tr = e.target.closest('tr'); const id = tr.dataset.id; const station = (window._stations||[]).find(x=>String(x.Station_ID||x.id||x.ID) === String(id));
				if (!station) { alert('Station not found'); return; }
				openDetail(station);
			}));
		}

		function openDetail(station){
			document.getElementById('modalTitle').innerText = 'Station: ' + (station.Station_ID || station.id || '');
			document.getElementById('modalName').value = station.Name || station.name || '';
			document.getElementById('modalAddress').value = station.Address || station.address || '';
			document.getElementById('detailModal').dataset.stationId = station.Station_ID || station.id || '';
			document.getElementById('detailModal').style.display = 'flex';
			renderModalCs(station.ChargingStations || []);
			document.getElementById('addCSForm').style.display = 'none';
		}

		function closeDetail(){
			document.getElementById('detailModal').style.display = 'none';
			document.getElementById('addCSForm').style.display = 'none';
		}

		function renderModalCs(list){
			const cont = document.getElementById('modalCsContainer');
			if (!Array.isArray(list) || list.length === 0) { cont.innerHTML = '<div class="muted">No charging stations</div>'; return; }
			let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th>ID</th><th>Name</th><th>Slot Cap</th><th>Type</th><th>Power</th><th>Actions</th></tr></thead><tbody>';
				list.forEach(c=>{
				const curType = (c.Slot_Type||c.slot_type||'') || '';
				const curPower = (c.Power_Rating||c.power_rating||'') || '';
				html += `<tr data-cid="${c.ChargingStation_ID||c.id}"><td>${c.ChargingStation_ID||c.id}</td><td><input class="modal-cs-name" value="${escapeHtml(c.Name||c.name||'')}" style="width:220px"/></td><td><input class="modal-cs-cap" type="number" value="${c.Slot_Capacity||0}" style="width:80px"/></td>`;
				html += `<td><select class="modal-cs-type" style="width:140px"><option value="">--</option><option value="Lithium-ion" ${curType==='Lithium-ion'?'selected':''}>Lithium-ion</option><option value="LFP" ${curType==='LFP'?'selected':''}>LFP</option></select></td>`;
				// normalize power value to numeric string for selection
				const curPowerValModal = (String(curPower).match(/\d+(?:\.\d+)?/) || [''])[0];
				html += `<td><select class="modal-cs-power" style="width:90px"><option value="">--</option><option value="5.0" ${curPowerValModal==='5.0'?'selected':''}>5.0 kW</option><option value="3.5" ${curPowerValModal==='3.5'?'selected':''}>3.5 kW</option></select></td>`;
				html += `<td><button class="btn modal-cs-save">Save</button> <button class="btn btn-danger modal-cs-delete">Delete</button></td></tr>`;
				});
			html += '</tbody></table>';
			cont.innerHTML = html;

			// attach modal CS handlers
			document.querySelectorAll('.modal-cs-save').forEach(btn=> btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; const stationId = document.getElementById('detailModal').dataset.stationId;
				const name = tr.querySelector('.modal-cs-name').value.trim(); const cap = parseInt(tr.querySelector('.modal-cs-cap').value||0,10); const type = tr.querySelector('.modal-cs-type').value.trim(); const power = tr.querySelector('.modal-cs-power').value.trim();
				try {
					const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
					const body = { action:'update', id: cid, station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
					const res = await postChargingStation(body);
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations(); closeDetail();
				} catch(err){ alert('CS update failed: '+err); }
			}));

			document.querySelectorAll('.modal-cs-delete').forEach(btn=> btn.addEventListener('click', async e=>{
				const tr = e.target.closest('tr'); const cid = tr.dataset.cid; if (!confirm('Delete CS '+cid+'?')) return;
				try {
					let res = await fetch(API_CS + '?id=' + encodeURIComponent(cid), { method: 'DELETE', credentials: 'include' });
					if (res.status === 404) {
						const form = new URLSearchParams(); form.append('action','delete'); form.append('id', cid);
						res = await fetch(BASE + '/admin/charging', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
					}
					if (!res.ok) throw new Error('HTTP '+res.status);
					fetchStations(); closeDetail();
				} catch(err){ alert('CS delete failed: '+err); }
			}));

			// synchronize type <-> power inside modal
			const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
			const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
			document.querySelectorAll('select.modal-cs-type').forEach(typeSel => {
				const tr = typeSel.closest('tr');
				const powerSel = tr.querySelector('select.modal-cs-power');
				if (!powerSel) return;
				typeSel.addEventListener('change', ()=>{ const p = mapTypeToPower(typeSel.value); if(p) powerSel.value = p; });
			});
			document.querySelectorAll('select.modal-cs-power').forEach(powerSel => {
				const tr = powerSel.closest('tr');
				const typeSel = tr.querySelector('select.modal-cs-type');
				if (!typeSel) return;
				powerSel.addEventListener('change', ()=>{ const t = mapPowerToType(powerSel.value); if(t) typeSel.value = t; });
			});
		}

		// modal control handlers
		document.getElementById('closeModal').addEventListener('click', closeDetail);

		document.getElementById('saveStationBtn').addEventListener('click', async () => {
			const stationId = document.getElementById('detailModal').dataset.stationId || 0;
			const name = document.getElementById('modalName').value.trim();
			const address = document.getElementById('modalAddress').value.trim();
			if (!name) { alert('Name required'); return; }
			try {
				// admin endpoint expects POST with Station_ID==0 for insert, else update
				const res = await fetch(API_STATIONS_CRUD, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ Station_ID: parseInt(stationId,10), Name: name, Address: address }) });
				if (!res.ok) throw new Error('HTTP '+res.status);
				fetchStations(); closeDetail();
			} catch(err){ alert('Save station failed: '+err); }
		});

		document.getElementById('openAddCS').addEventListener('click', () => {
			document.getElementById('csName').value = '';
			document.getElementById('csCap').value = 1;
			document.getElementById('csType').value = '';
			document.getElementById('csPower').value = '';
			document.getElementById('addCSForm').dataset.stationId = document.getElementById('detailModal').dataset.stationId;
			document.getElementById('addCSForm').dataset.editId = '';
			document.getElementById('addCSForm').style.display = 'block';
		});

		document.getElementById('cancelCSBtn').addEventListener('click', () => { document.getElementById('addCSForm').style.display = 'none'; });

		document.getElementById('createCSBtn').addEventListener('click', async () => {
			const stationId = document.getElementById('addCSForm').dataset.stationId;
			const name = document.getElementById('csName').value.trim(); const cap = parseInt(document.getElementById('csCap').value||0,10);
			const type = document.getElementById('csType').value.trim(); const power = document.getElementById('csPower').value.trim();
			if (!name) { alert('Name required'); return; }
			try {
				// normalize power to numeric and send using helper that falls back to legacy servlet
				const pr = parseFloat(String(power).replace(/[^0-9.]/g,'')) || 0;
				const body = { action: 'create', station_id: stationId, name: name, slot_capacity: cap, slot_type: type, power_rating: pr };
				const res = await postChargingStation(body);
				if (!res.ok) throw new Error('HTTP '+res.status);
				fetchStations(); document.getElementById('addCSForm').style.display='none'; closeDetail();
			} catch(err){ alert('Create CS failed: '+err); }
		});

		// sync addCSForm type <-> power
		const addType = document.getElementById('csType');
		const addPower = document.getElementById('csPower');
		if (addType && addPower) {
			const mapTypeToPower = (t) => t === 'Lithium-ion' ? '5.0' : (t === 'LFP' ? '3.5' : '');
			const mapPowerToType = (p) => p === '5.0' ? 'Lithium-ion' : (p === '3.5' ? 'LFP' : '');
			addType.addEventListener('change', ()=>{ const p = mapTypeToPower(addType.value); if(p) addPower.value = p; });
			addPower.addEventListener('change', ()=>{ const t = mapPowerToType(addPower.value); if(t) addType.value = t; });
		}

		function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>\\"]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]; }); }

		// --- User management JS ---
		const API_USERS = BASE + '/api/admin/users';
		const DEFAULT_AVATAR = BASE + '/resources/images/avatar_default.svg';

		function getAuthHeaders(){
			const headers = { 'Content-Type': 'application/json' };
			try {
				const token = localStorage.getItem('adminToken') || '';
				if (token) headers['Authorization'] = 'Bearer ' + token;
			} catch(e) {}
			return headers;
		}

		async function fetchUsers(){
			const q = document.getElementById('userSearch').value.trim();
			const role = document.getElementById('roleFilter').value;
			let url = API_USERS;
			const params = [];
			if (role) params.push('role=' + encodeURIComponent(role));
			if (q) params.push('q=' + encodeURIComponent(q));
			if (params.length) url += '?' + params.join('&');
			
			const container = document.getElementById('usersContainer');
			container.innerHTML = '<div style="text-align:center;padding:40px 20px"><div style="display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #1976d2;border-radius:50%;animation:spin 1s linear infinite"></div><p class="muted" style="margin-top:12px">ƒêang t·∫£i danh s√°ch nh√¢n s·ª±...</p></div>';
			
			try {
				const res = await fetch(url, { method: 'GET', credentials: 'include', headers: getAuthHeaders() });
				if (!res.ok) throw new Error('HTTP ' + res.status);
				const users = await res.json();
				renderUsers(users || []);
			} catch(err){ 
				document.getElementById('usersContainer').innerHTML = '<div class="muted">Error loading users: '+err+'</div>'; 
				throw err; // Re-throw to trigger catch in button handler
			}
		}

		function renderUsers(users){
			const c = document.getElementById('usersContainer');
			if (!Array.isArray(users) || users.length === 0) { c.innerHTML = '<div class="muted">No users found</div>'; return; }
			// keep a copy for modal lookups
			window._users = users;
			let html = '<table><thead><tr><th>ID</th><th>Full name</th><th>Email</th><th>Phone</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
			users.forEach(u=>{
				const id = u.id || u.Id || u.ID;
				const avatar = u.avatarUrl || u.avatar || u.Avatar_URL || '';
				const status = (u.status || u.Status || '') + '';
				const role = u.role || u.Role || '';
				// status badge styles
				let badgeColor = '#999'; // pending/none
				if ((status||'').toLowerCase() === 'active') badgeColor = '#2e7d32';
				if ((status||'').toLowerCase() === 'blocked') badgeColor = '#c62828';
				const badgeHtml = `<div style="display:inline-block;margin-left:8px;padding:2px 8px;border-radius:12px;background:${badgeColor};color:#fff;font-size:12px;vertical-align:middle">${escapeHtml(status|| (role? 'Active' : ''))}</div>`;
				// allow Edit/Delete for blocked users as well (admins must be able to unblock)
				html += `<tr data-uid="${id}"><td>${id}</td><td><div style="display:flex;align-items:center;gap:8px"><img src="${escapeHtml(avatar || DEFAULT_AVATAR)}" style="width:40px;height:40px;border-radius:50%"/> ${escapeHtml(u.fullName||u.fullname||u.FullName||'')}</div></td><td>${escapeHtml(u.email||'')}</td><td>${escapeHtml(u.phone||'')}</td><td>${escapeHtml(role||'')}${badgeHtml}</td><td><button class="btn" data-action="edit-user">Edit</button> <button class="btn btn-danger" data-action="delete-user">Delete</button></td></tr>`;
			});
			html += '</tbody></table>';
			c.innerHTML = html;
			// attach handlers
			document.querySelectorAll('button[data-action="edit-user"]').forEach(b=> b.addEventListener('click', e=>{
				const id = e.target.closest('tr').dataset.uid; const row = e.target.closest('tr');
				const usersList = window._users || [];
				const user = usersList.find(x=> String(x.id||x.ID) === String(id));
				openUserModal(user || { id: id });
			}));
			document.querySelectorAll('button[data-action="delete-user"]').forEach(b=> b.addEventListener('click', async e=>{
				const id = e.target.closest('tr').dataset.uid; if (!confirm('Delete user '+id+'?')) return;
				try { const res = await fetch(API_USERS + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include', headers: getAuthHeaders() }); if (!res.ok) throw new Error('HTTP '+res.status); fetchUsers(); } catch(err){ alert('Delete failed: '+err); }
			}));
		}

		function openUserModal(user){
			document.getElementById('userModalTitle').innerText = user && user.id ? 'Edit User: ' + user.id : 'Create Staff';
			document.getElementById('uFullName').value = user.fullName || user.fullname || '';
			document.getElementById('uEmail').value = user.email || '';
			document.getElementById('uPhone').value = user.phone || '';
			document.getElementById('uRole').value = user.role || 'Staff';
			document.getElementById('userModal').dataset.userId = user.id || '';
			// default status: if creating a new user from admin UI, default to Active so admin-created accounts are active immediately
			let statusVal = user.status || user.Status || '';
			if (!user || !user.id) statusVal = statusVal || 'Active';
			document.getElementById('uStatus').value = statusVal;
			// show inline status notice and disable actions if Blocked or None (only for existing users)
			try {
				let notice = document.getElementById('uStatusNotice');
				if (!notice) {
					notice = document.createElement('div');
					notice.id = 'uStatusNotice';
					notice.style.marginTop = '6px';
					notice.style.fontSize = '13px';
					notice.style.color = '#333';
					document.getElementById('uStatus').parentElement.appendChild(notice);
				}
				// compute current status from the value we set above (handles new user default)
				const st = (document.getElementById('uStatus').value || '').toString().toLowerCase();
				// store original status for unblock confirmation when saving
				document.getElementById('userModal').dataset.originalStatus = st || '';
				// If creating a new user (no id), do not block Save for missing/none status ‚Äî admin-created accounts should be Active
				if (!user || !user.id) {
					notice.innerText = '';
					document.getElementById('saveUserBtn').disabled = false;
					document.getElementById('deleteUserBtn').disabled = true; // nothing to delete yet
					document.getElementById('resetPasswordBtn').disabled = true;
				} else if (st === 'blocked') {
					notice.innerText = 'T√†i kho·∫£n n√†y ƒëang b·ªã kh√≥a ‚Äî Admin c√≥ th·ªÉ m·ªü kh√≥a b·∫±ng c√°ch thay ƒë·ªïi tr·∫°ng th√°i th√†nh Active';
					notice.style.color = '#c62828';
					// allow admins to perform unblock via this UI (buttons remain enabled)
					document.getElementById('saveUserBtn').disabled = false;
					document.getElementById('deleteUserBtn').disabled = false;
					document.getElementById('resetPasswordBtn').disabled = false;
				} else if (!st || st === 'none' || st === '(none)') {
					notice.innerText = 'T√†i kho·∫£n ch∆∞a k√≠ch ho·∫°t ‚Äî h√£y y√™u c·∫ßu ho√†n t·∫•t ƒëƒÉng k√Ω/verify';
					notice.style.color = '#777';
					document.getElementById('saveUserBtn').disabled = true; // require activation first for existing self-registered users
					document.getElementById('deleteUserBtn').disabled = false; // allow delete
					document.getElementById('resetPasswordBtn').disabled = true;
				} else {
					notice.innerText = '';
					document.getElementById('saveUserBtn').disabled = false;
					document.getElementById('deleteUserBtn').disabled = false;
					document.getElementById('resetPasswordBtn').disabled = false;
				}
			} catch(e) {}
			// populate station select from loaded stations
			try {
				const sel = document.getElementById('uStationId');
				if (sel) {
					sel.innerHTML = '<option value="">-- Select station --</option>';
					const stations = window._stations || [];
					stations.forEach(s => {
						const id = s.Station_ID || s.StationId || s.id || s.ID;
						const name = s.Name || s.name || ('Station ' + id);
						const opt = document.createElement('option'); opt.value = id; opt.text = name; sel.appendChild(opt);
					});
					// set selected value if present on user
					if (user && (user.stationId || user.Station_ID || user.StationId)) sel.value = user.stationId || user.Station_ID || user.StationId;
				}
			} catch(e) {}
			document.getElementById('uAvatar').value = user.avatarUrl || user.avatar || user.Avatar_URL || '';
			const preview = document.getElementById('uAvatarPreview');
			if (preview) { const val = document.getElementById('uAvatar').value && document.getElementById('uAvatar').value.trim(); preview.src = val ? val : DEFAULT_AVATAR; preview.style.display = 'inline-block'; }
			document.getElementById('deleteUserBtn').style.display = user && user.id ? 'inline-block' : 'none';
			document.getElementById('resetPasswordBtn').style.display = user && user.id ? 'inline-block' : 'none';
			// disable role change if editing an Admin user
			try {
				const roleSel = document.getElementById('uRole');
				if (roleSel) {
					if (user && (user.role||user.Role||'').toString().toLowerCase() === 'admin') {
						// keep admin role immutable via this UI
						roleSel.disabled = true;
					} else {
						roleSel.disabled = false;
					}
					// hide station selector for Admin and Manager (both don't have Station_ID)
					try {
						const ur = (user && (user.role||user.Role||'') || '').toString().toLowerCase();
						if (ur === 'admin' || ur === 'manager') document.getElementById('uStationId').parentElement.style.display = 'none';
						else document.getElementById('uStationId').parentElement.style.display = '';
					} catch(e) { /* ignore */ }
				}
			} catch(e) {}
			document.getElementById('userModal').style.display = 'flex';
		}

		document.getElementById('closeUserModal').addEventListener('click', ()=>{ document.getElementById('userModal').style.display = 'none'; });

		document.getElementById('createStaffBtn').addEventListener('click', ()=> {
			if (!_usersOpen || !_usersLoaded) return; // Only allow if users list is open
			openUserModal({});
		});

		document.getElementById('filterUsers').addEventListener('click', ()=> {
			if (!_usersOpen || !_usersLoaded) return; // Only allow if users list is open
			fetchUsers();
		});

		document.getElementById('uAvatar').addEventListener('input', (e)=>{
			const preview = document.getElementById('uAvatarPreview');
			if (!preview) return;
			const v = e.target.value && e.target.value.trim();
			preview.src = v ? v : DEFAULT_AVATAR;
			preview.style.display = 'inline-block';
		});

		// file input preview
		document.getElementById('uAvatarFile').addEventListener('change', (e)=>{
			const f = e.target.files && e.target.files[0];
			const preview = document.getElementById('uAvatarPreview');
			if (!preview) return;
			if (!f) { preview.src = DEFAULT_AVATAR; return; }
			const reader = new FileReader();
			reader.onload = function(ev){ preview.src = ev.target.result; };
			reader.readAsDataURL(f);
		});

		// switch mode enable/disable
		document.querySelectorAll('input[name="avatarMode"]').forEach(r=> r.addEventListener('change', ()=>{
			const mode = document.querySelector('input[name="avatarMode"]:checked').value;
			document.getElementById('uAvatar').disabled = (mode!=='url');
			document.getElementById('uAvatarFile').disabled = (mode!=='upload');
		}));

		document.getElementById('saveUserBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId || 0;
			const fullName = document.getElementById('uFullName').value.trim();
			const email = document.getElementById('uEmail').value.trim();
			const phone = document.getElementById('uPhone').value.trim();
			const role = document.getElementById('uRole').value;
			const status = document.getElementById('uStatus').value || '';
			const avatar = document.getElementById('uAvatar').value.trim() || '';
			const stationId = document.getElementById('uStationId') ? document.getElementById('uStationId').value : '';
			const password = document.getElementById('uPassword') ? document.getElementById('uPassword').value : '';
			if (!fullName || !email) { alert('Name and email required'); return; }
			try {
				// if original status was 'blocked' and admin is setting to 'Active', ask for confirmation
				const orig = (document.getElementById('userModal').dataset.originalStatus || '').toString().toLowerCase();
				if (orig === 'blocked' && (status||'').toString().toLowerCase() === 'active') {
					if (!confirm('Are you sure you want to unblock this user?')) return;
				}
				const method = id && Number(id) > 0 ? 'PUT' : 'POST';
				const url = API_USERS;
				// determine avatar mode: url or upload
				const mode = document.querySelector('input[name="avatarMode"]:checked') ? document.querySelector('input[name="avatarMode"]:checked').value : 'url';
				let res;
                    if (mode === 'upload' && document.getElementById('uAvatarFile').files && document.getElementById('uAvatarFile').files.length > 0) {
					const fd = new FormData();
					fd.append('id', Number(id||0));
					fd.append('fullName', fullName);
					fd.append('email', email);
					fd.append('phone', phone);
					fd.append('role', role);
					fd.append('status', status);
					if (stationId) fd.append('stationId', stationId);
					if (password && password.length > 0) fd.append('password', password);
					const file = document.getElementById('uAvatarFile').files[0];
					fd.append('avatarFile', file, file.name);
					// send multipart; do NOT set Content-Type so browser sets boundary
					const headers = getAuthHeaders(); delete headers['Content-Type'];
					res = await fetch(url, { method: method, credentials: 'include', headers: headers, body: fd });
				} else {
					const body = { id: Number(id||0), fullName: fullName, email: email, phone: phone, role: role, status: status, avatarUrl: avatar };
					if (stationId) body.stationId = Number(stationId);
					if (password && password.length > 0) body.password = password;
					res = await fetch(url, { method: method, credentials: 'include', headers: Object.assign({'Content-Type':'application/json'}, getAuthHeaders()), body: JSON.stringify(body) });
				}
				if (!res.ok) throw new Error('HTTP '+res.status);
				document.getElementById('userModal').style.display = 'none';
				fetchUsers();
			} catch(err){
				try {
					const msg = err && err.message ? err.message : String(err);
					const ml = (msg || '').toLowerCase();
					// if server indicates duplicate email or phone, show Vietnamese friendly messages
					if (ml.includes('email') || ml.includes('email ƒë√£ t·ªìn t·∫°i') || ml.includes('kh√¥ng th·ªÉ t·∫°o staff do email')) {
						alert('Kh√¥ng th·ªÉ t·∫°o Staff do email ƒë√£ t·ªìn t·∫°i');
					} else if (ml.includes('phone') || ml.includes('s·ªë ƒëi·ªán tho·∫°i') || ml.includes('kh√¥ng th·ªÉ t·∫°o staff do s·ªë ƒëi·ªán tho·∫°i')) {
						alert('Kh√¥ng th·ªÉ t·∫°o Staff do s·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i');
					} else {
						alert('Save user failed: ' + msg);
					}
				} catch(e2) { alert('Save user failed: ' + err); }
			}
		});

		document.getElementById('deleteUserBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId; if (!id) return; if (!confirm('Delete user '+id+'?')) return;
			try { const res = await fetch(API_USERS + '?id=' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include', headers: getAuthHeaders() }); if (!res.ok) throw new Error('HTTP '+res.status); document.getElementById('userModal').style.display = 'none'; fetchUsers(); } catch(err){ alert('Delete failed: '+err); }
		});

		document.getElementById('resetPasswordBtn').addEventListener('click', async ()=>{
			const id = document.getElementById('userModal').dataset.userId; if (!id) return; if (!confirm('Reset password for user '+id+' to default?')) return;
			try {
				const defaultPwd = 'ChangeMe123!';
				// set password field and trigger save (PUT)
				document.getElementById('uPassword').value = defaultPwd;
				const res = await fetch(API_USERS, { method: 'PUT', credentials: 'include', headers: Object.assign({'Content-Type':'application/json'}, getAuthHeaders()), body: JSON.stringify({ id: Number(id), password: defaultPwd }) });
				if (!res.ok) throw new Error('HTTP '+res.status);
				alert('Password reset to default: ' + defaultPwd);
				document.getElementById('userModal').style.display = 'none';
				fetchUsers();
			} catch(err){ alert('Reset password failed: '+err); }
		});

		// expose users data for editing handler lookup
		window._users = window._users || [];

		// initial load: stations and users
		fetchStations();
		fetchUsers();
	</script>
</body>
</html>
